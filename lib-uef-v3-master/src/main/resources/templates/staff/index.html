<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Th∆∞ vi·ªán Tr·ª±c tuy·∫øn - B·∫£ng ƒëi·ªÅu khi·ªÉn Th·ªß th∆∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap"
          rel="stylesheet">
    <style>
        :root {
            /* New Mint & Teal Theme */
            --primary: #2E935D; /* Main green for actions */
            --primary-light: #4CAF7A; /* Lighter green for hovers */
            --primary-dark: #176335; /* Darker green for headers/text */
            --secondary: #B3E0D2; /* Light teal accent */
            --light: #F2FDF6; /* Main background - very light green */
            --dark: #293D31; /* Dark green/gray text */
            --card-bg: #FFFFFF; /* Clean white for cards */
            --text-on-primary: #FFFFFF; /* White text on primary color */
            --text-on-secondary: #293D31; /* Dark text on secondary color */
            --text-light-custom: #677C6F; /* Lighter gray-green for secondary text */
            --footer-bg-custom: #176335; /* Dark green footer */
            --footer-text-custom: #C0D1C7; /* Light text for footer */
            --footer-link-hover-custom: #dfffe9; /* Original requested color for hover */
            --nav-bar-bg: rgba(242, 253, 246, 0.9); /* Translucent light green */
            --box-shadow-base-color-rgb: 46, 147, 93; /* RGB for --primary */
            --border-subtle: #DCEEE3; /* Subtle green border */
            --accordion-button-active-bg: rgba(46, 147, 93, 0.05); /* Light primary for active accordion */
            --input-bg-custom: #FFFFFF;

            /* Sidebar specific colors */
            --sidebar-bg: #EAFBF1; /* Soft mint green for sidebar */
            --sidebar-link-hover: #D3EADC; /* Slightly darker mint for hover */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            background-color: var(--nav-bar-bg);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border-subtle);
        }

        .navbar-brand {
            color: var(--primary-dark) !important;
            font-family: 'Playfair Display', serif;
            font-size: 1.7rem;
            font-weight: 700;
        }

        .navbar-brand span {
            color: var(--primary);
        }

        .nav-link {
            color: var(--dark) !important;
            font-weight: 500;
            margin: 0 10px;
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background-color: var(--primary);
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }

        .nav-link.active {
            color: var(--primary) !important;
        }

        .user-avatar-icon, .user-notification-icon {
            color: var(--dark);
            font-size: 1.3rem;
            transition: color 0.2s ease;
        }

        .user-avatar-icon:hover, .user-notification-icon:hover {
            color: var(--primary);
        }

        .user-avatar-dropdown {
            border: 2px solid var(--border-subtle) !important;
        }

        .dropdown-username {
            color: var(--primary-dark);
            font-weight: 600;
        }

        .dropdown-item i {
            color: var(--primary-light);
        }

        .dropdown-item:hover i {
            color: var(--primary);
        }

        /* Hero Section (Librarian Home Banner) */


        /* Wrapper for Sidebar and Content */
        .wrapper {
            display: flex;
            width: 100%;
            flex: 1;
        }

        /* Sidebar */
        #sidebar {
            width: 260px;
            min-width: 260px;
            background: var(--sidebar-bg);
            box-shadow: 2px 0 15px rgba(var(--box-shadow-base-color-rgb), 0.1);
            transition: all 0.3s;
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* --- CSS ƒê√É C·∫¢I TI·∫æN --- */
        .sidebar-header {
            padding: 20px 25px; /* TƒÉng kho·∫£ng c√°ch l·ªÅ ngang */
            background: transparent; /* B·ªè n·ªÅn ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi sidebar */
            border-bottom: 1px solid var(--border-subtle);
            text-align: left; /* CƒÉn l·ªÅ tr√°i */
        }

        .sidebar-header h3 {
            color: var(--primary-dark); /* ƒê·ªïi m√†u ch·ªØ cho ƒë·∫≠m h∆°n m·ªôt ch√∫t */
            font-family: 'Playfair Display', serif;
            margin-bottom: 0;
            font-size: 1.6rem; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ m·ªôt ch√∫t cho c√¢n ƒë·ªëi */
            display: flex; /* B·∫≠t flexbox ƒë·ªÉ cƒÉn ch·ªânh icon v√† ch·ªØ */
            align-items: center;
            gap: 12px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
        }

        /* --- CSS ƒê√É C·∫¢I TI·∫æN --- */
        .sidebar-menu {
            padding: 15px; /* Th√™m padding cho to√†n b·ªô kh·ªëi menu */
            margin: 0;
        }

        .sidebar-menu .nav-item {
            font-weight: 500;
            margin-bottom: 5px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c m·ª•c menu */
        }

        .sidebar-menu .nav-link {
            padding: 12px 18px; /* ƒêi·ªÅu ch·ªânh l·∫°i padding */
            color: var(--dark);
            display: flex;
            align-items: center;
            border-radius: 8px; /* Bo tr√≤n c√°c g√≥c */
            transition: all 0.25s ease-in-out;
            /* B·ªè border-left ƒë·ªÉ thay b·∫±ng hi·ªáu ·ª©ng n·ªÅn */
        }

        .sidebar-menu .nav-link i {
            width: 30px;
            text-align: center;
            margin-right: 12px; /* TƒÉng nh·∫π kho·∫£ng c√°ch icon v√† ch·ªØ */
            font-size: 1.1rem;
            transition: all 0.25s ease-in-out;
        }

        /* Hi·ªáu ·ª©ng khi hover cho c√°c m·ª•c ch∆∞a active */
        .sidebar-menu .nav-link:not(.active):hover {
            background: var(--sidebar-link-hover);
            color: var(--primary-dark);
            transform: translateX(5px); /* Hi·ªáu ·ª©ng di chuy·ªÉn nh·∫π sang ph·∫£i */
        }

        /* Hi·ªáu ·ª©ng cho m·ª•c ƒëang active (ƒë∆∞·ª£c ch·ªçn) */
        .sidebar-menu .nav-link.active {
            background: var(--primary);
            color: var(--text-on-primary) !important;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(var(--box-shadow-base-color-rgb), 0.25);
        }

        /* ƒê·ªïi c·∫£ m√†u icon khi active */
        .sidebar-menu .nav-link.active i {
            color: var(--text-on-primary) !important;
        }

        /* Content Area */
        #content {
            flex-grow: 1;
            padding: 25px 25px 25px 80px;
            overflow-y: auto;
            position: relative;
        }

        .page-header {
            font-family: 'Playfair Display', serif;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 2.2rem;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 12px rgba(var(--box-shadow-base-color-rgb), 0.08);
            margin-bottom: 25px;
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--primary-dark);
            font-size: 1.1rem;
            padding: 15px 20px;
        }

        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            color: var(--text-on-primary);
            padding: 8px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--secondary);
            border-color: var(--secondary);
            color: var(--text-on-secondary);
            padding: 8px 20px;
            border-radius: 5px;
        }

        .btn-secondary:hover {
            background-color: #97C7B7; /* Darker secondary */
            border-color: #97C7B7;
            color: var(--text-on-secondary);
        }

        .btn-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }

        .btn-info:hover {
            background-color: #31d2f2;
            border-color: #25cff2;
        }

        .btn-outline-primary {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: var(--text-on-primary);
        }

        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: #fff;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: #fff;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }


        .table {
            background-color: var(--card-bg);
            margin-bottom: 0;
        }

        .table thead th {
            background-color: var(--sidebar-bg);
            color: var(--primary-dark);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-light);
        }

        .table tbody tr:hover {
            background-color: var(--sidebar-link-hover);
        }

        .table .badge {
            font-size: 0.9em;
            padding: 0.5em 0.7em;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background-color: var(--input-bg-custom);
            color: var(--dark);
            padding: 10px 15px;
        }

        .form-control::placeholder {
            color: var(--text-light-custom);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(var(--box-shadow-base-color-rgb), 0.25);
            background-color: var(--input-bg-custom);
        }

        /* Modal */
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(var(--box-shadow-base-color-rgb), 0.15);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-subtle);
            padding: 20px;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary);
        }

        .modal-footer {
            border-top: 1px solid var(--border-subtle);
            padding: 15px 20px;
        }

        /* --- STYLES FOR ACCORDION (GENERIC) --- */
        .accordion-button-custom {
            background-color: var(--card-bg) !important;
            color: var(--dark) !important;
            box-shadow: none !important;
            border-top: 1px solid var(--border-subtle);
        }
        .accordion-button-custom:not(.collapsed) {
            background-color: var(--accordion-button-active-bg) !important;
            color: var(--primary-dark) !important;
        }
        .accordion-button-custom:after {
            filter: brightness(0) saturate(100%) invert(18%) sepia(16%) saturate(1149%) hue-rotate(95deg) brightness(95%) contrast(84%);
        }
        .accordion-item-custom {
            border: none;
        }
        .accordion-body-custom {
            background-color: var(--light);
            padding: 0;
        }
        .detail-item-table { /* Changed from book-item-table */
            width: 100%;
            border-collapse: collapse;
        }
        .detail-item-table td, .detail-item-table th {
            padding: 0.75rem 1.25rem;
            vertical-align: middle;
        }
        .detail-item-table tr:not(:last-child) {
            border-bottom: 1px solid var(--border-subtle);
        }
        .accordion-footer-custom {
            padding: 1rem 1.25rem;
            text-align: right;
            background-color: var(--sidebar-bg);
            border-top: 1px solid var(--border-subtle);
        }
        /* ------------------------------------------- */


        /* Footer */
        footer {
            background-color: var(--footer-bg-custom);
            color: var(--footer-text-custom);
            padding: 60px 0 20px;
            margin-top: auto;
        }

        .footer-title {
            color: var(--light);
            font-weight: 600;
            margin-bottom: 25px;
            font-size: 1.3rem;
        }

        .footer-links {
            list-style: none;
            padding: 0;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: var(--footer-text-custom);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--footer-link-hover-custom);
            padding-left: 5px;
        }

        .footer-links i.me-2 {
            color: var(--footer-text-custom);
            transition: all 0.3s ease;
        }

        .footer-links a:hover i.me-2 {
            color: var(--footer-link-hover-custom);
        }

        .social-links {
            margin-top: 20px;
        }

        .social-links a {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background-color: rgba(223, 255, 233, 0.1);
            color: var(--footer-link-hover-custom);
            border-radius: 50%;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .social-links a:hover {
            background-color: var(--primary);
            color: var(--text-on-primary);
            transform: translateY(-3px);
        }

        .footer-bottom {
            border-top: 1px solid rgba(223, 255, 233, 0.15);
            padding-top: 20px;
            margin-top: 40px;
            font-size: 0.9rem;
        }

        .footer-bottom p a {
            color: var(--footer-text-custom) !important;
            opacity: 0.8;
        }

        .footer-bottom p a:hover {
            color: var(--footer-link-hover-custom) !important;
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            #sidebar {
                margin-left: -260px;
                position: fixed;
                top: 0;
                bottom: 0;
                height: 100vh;
                z-index: 1040;
                padding-top: 0;
            }

            #sidebar.active {
                margin-left: 0;
            }

            .wrapper {
                flex-direction: column;
            }

            #content {
                width: 100%;
                padding: 15px;
            }

            body {
                padding-top: 56px;
            }

            .navbar.fixed-top {
                box-shadow: 0 2px 10px rgba(var(--box-shadow-base-color-rgb), 0.07);
            }

            .staff-hero-section {
                height: 250px;
                margin-top: 0;
            }

            .staff-hero-section h1 {
                font-size: 2.5rem;
            }

            .staff-hero-section p {
                font-size: 1.1rem;
            }

            .page-header {
                font-size: 1.8rem;
            }

            .footer-bottom .col-md-6 {
                text-align: center !important;
                margin-bottom: 10px;
            }

            .footer-bottom .col-md-6.text-md-end {
                text-align: center !important;
            }
        }

        /* Toggle button for sidebar on small screens */
        .sidebar-toggle-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1050;
            background-color: var(--primary);
            color: var(--text-on-primary);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 1.2rem;
        }

        @media (max-width: 992px) {
            .sidebar-toggle-btn {
                display: block;
            }
        }

        /* Overlay khi sidebar m·ªü */
        .overlay {
            display: none;
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1030;
        }

        .overlay.active {
            display: block;
        }

        /* N√∫t b·∫•m ƒëi·ªÅu khi·ªÉn ch√≠nh */
        /* === B·∫ÆT ƒê·∫¶U ƒêO·∫†N M√É CSS C·∫¶N THAY TH·∫æ === */

        /* --- CSS for Sidebar Toggle --- */

        /* N√∫t b·∫•m ƒëi·ªÅu khi·ªÉn ch√≠nh tr√™n desktop */
        #sidebar-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 280px; /* V·ªã tr√≠ ban ƒë·∫ßu = chi·ªÅu r·ªông sidebar (260) + 20px */
            z-index: 1051;
            background-color: var(--card-bg);
            border: 1px solid var(--border-subtle);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            transition: all 0.35s ease-in-out;
            color: var(--primary);
            box-shadow: 0 2px 10px rgba(var(--box-shadow-base-color-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sidebar-toggle-btn:hover {
            background-color: var(--primary);
            color: var(--text-on-primary);
        }

        #sidebar-toggle-btn i {
            transition: transform 0.35s ease-in-out;
        }

        /* Hi·ªáu ·ª©ng tr∆∞·ª£t cho sidebar */
        #sidebar {
            transition: margin-left 0.35s ease-in-out;
        }

        /* Layout khi sidebar b·ªã thu g·ªçn (body.sidebar-collapsed) */
        body.sidebar-collapsed #sidebar {
            margin-left: -260px; /* Tr∆∞·ª£t sidebar ra ngo√†i */
        }

        body.sidebar-collapsed #sidebar-toggle-btn {
            left: 20px; /* Di chuy·ªÉn n√∫t b·∫•m v·ªÅ s√°t l·ªÅ tr√°i */
        }

        body.sidebar-collapsed #sidebar-toggle-btn i {
            transform: rotate(180deg); /* Xoay icon m≈©i t√™n */
        }

        /* ·∫®n n√∫t toggle desktop tr√™n m√†n h√¨nh mobile */
        @media (max-width: 992px) {
            #sidebar-toggle-btn {
                display: none;
            }
        }
        /* === K·∫æT TH√öC ƒêO·∫†N M√É CSS C·∫¶N THAY TH·∫æ === */
    </style>
    <style>
        /* --- ƒê·ªãnh d·∫°ng m√†u s·∫Øc m·ªõi cho th·∫ª th·ªëng k√™ --- */
        .card-border-brown { border-left: 4px solid var(--primary); }
        .text-brown { color: var(--primary) !important; }

        .card-border-terracotta { border-left: 4px solid var(--primary-light); }
        .text-terracotta { color: var(--primary-light) !important; }

        .card-border-olive { border-left: 4px solid #468966; }
        .text-olive { color: #468966 !important; }

        .card-border-sand { border-left: 4px solid var(--secondary); }
        .text-sand { color: var(--secondary) !important; }

        .card-border-slate { border-left: 4px solid #0097A7; }
        .text-slate { color: #0097A7 !important; }

        .text-gray-400 { color: var(--text-light-custom) !important; }

        /* --- ƒê·ªãnh d·∫°ng cho L·ªãch --- */
        .calendar-container {
            background-color: var(--card-bg);
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 12px rgba(var(--box-shadow-base-color-rgb), 0.08);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0.5rem;
            color: var(--primary-dark);
        }
        .calendar-header h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            color: var(--primary);
        }
        .calendar-weekdays, .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-weekdays div {
            text-align: center;
            font-weight: 600;
            color: var(--text-light-custom);
            padding: 0.5rem 0;
        }
        .calendar-days div {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: default;
            transition: all 0.2s ease-in-out;
        }
        .calendar-days div.prev-month,
        .calendar-days div.next-month {
            opacity: 0.4;
        }
        .calendar-days div.today {
            background-color: var(--primary) !important;
            color: var(--text-on-primary) !important;
            border-color: var(--primary-dark) !important;
            font-weight: 700;
        }

        /* --- ƒê·ªãnh d·∫°ng cho Th∆∞ vi·ªán ·∫£nh --- */
        .inspiration-gallery .img-fluid {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            object-fit: cover;
            height: 200px; /* ƒê·∫£m b·∫£o c√°c ·∫£nh cao b·∫±ng nhau */
            width: 100%;
        }
        .inspiration-gallery .img-fluid:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        /* Giao di·ªán m·ªõi cho Dropdown th√¥ng b√°o - THEME XANH M√ÅT */
        .notification-dropdown-menu {
            width: 360px;
            max-width: 90vw;
            padding: 0;
            border: 1px solid var(--border-subtle); /* Thay ƒë·ªïi m√†u vi·ªÅn */
            background-color: var(--card-bg);      /* N·ªÅn tr·∫Øng s·∫°ch s·∫Ω gi·ªëng c√°c card kh√°c */
            box-shadow: 0 5px 20px rgba(var(--box-shadow-base-color-rgb), 0.1); /* S·ª≠ d·ª•ng bi·∫øn m√†u ƒë·ªï b√≥ng */
            border-radius: 8px; /* Th√™m bo g√≥c cho m·ªÅm m·∫°i */
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--dark); /* Thay ƒë·ªïi m√†u ch·ªØ */
            background-color: var(--light); /* N·ªÅn xanh r·∫•t nh·∫°t ƒë·ªìng b·ªô v·ªõi trang */
        }

        .notification-header span {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .notification-header a {
            font-size: 12px;
            color: var(--primary); /* S·ª≠ d·ª•ng m√†u xanh ch√≠nh c·ªßa trang */
        }

        /* Container cho danh s√°ch ƒë·ªÉ c√≥ th·ªÉ cu·ªôn */
        #notificationListContainer {
            max-height: 400px;
            overflow-y: auto;
        }

        /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·ªìng b·ªô */
        #notificationListContainer::-webkit-scrollbar {
            width: 6px;
        }
        #notificationListContainer::-webkit-scrollbar-track {
            background: transparent;
        }
        #notificationListContainer::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 6px;
        }
        #notificationListContainer::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle); /* Thay ƒë·ªïi m√†u ƒë∆∞·ªùng k·∫ª */
            transition: background-color 0.2s ease-in-out;
            position: relative;
        }

        .notification-item:hover {
            background-color: var(--sidebar-link-hover); /* M√†u hover gi·ªëng sidebar (g·∫ßn v·ªõi #dfffe9) */
        }

        /* ƒê√°nh d·∫•u th√¥ng b√°o ch∆∞a ƒë·ªçc */
        .notification-item.unread {
            background-color: var(--sidebar-bg); /* N·ªÅn xanh nh·∫°t cho th√¥ng b√°o ch∆∞a ƒë·ªçc */
        }

        .notification-item .notification-icon {
            font-size: 1rem;
            margin-right: 12px;
            margin-top: 4px;
            width: 20px;
            text-align: center;
        }

        /* Ch·∫•m tr√≤n cho th√¥ng b√°o ch∆∞a ƒë·ªçc */
        .notification-item.unread .notification-icon .fa-circle {
            font-size: 0.6rem;
            color: var(--primary);
        }

        .notification-content-text {
            flex-grow: 1;
            cursor: pointer;
        }

        .notification-content-text .title-link {
            font-weight: 600;
            color: var(--primary-dark); /* Thay ƒë·ªïi m√†u ti√™u ƒë·ªÅ */
            text-decoration: none;
        }
        .notification-content-text .title-link:hover {
            text-decoration: underline;
        }

        .notification-content-text .message {
            font-size: 14px;
            color: var(--dark); /* Thay ƒë·ªïi m√†u n·ªôi dung */
            margin-bottom: 4px;
        }

        .notification-content-text .time-ago {
            font-size: 12px;
            color: var(--text-light-custom); /* Thay ƒë·ªïi m√†u th·ªùi gian */
        }

        .delete-notification-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            opacity: 0; /* ·∫®n n√∫t x√≥a m·∫∑c ƒë·ªãnh */
            transition: opacity 0.2s, background-color 0.2s;
        }

        .notification-item:hover .delete-notification-btn {
            opacity: 1; /* Hi·ªán khi hover v√†o item */
        }

        .delete-notification-btn:hover {
            background-color: var(--border-subtle); /* Thay ƒë·ªïi m√†u hover n√∫t x√≥a */
        }

        .dropdown-divider {
            margin: 0;
            border-top: 1px solid var(--border-subtle); /* Thay ƒë·ªïi m√†u ƒë∆∞·ªùng k·∫ª */
        }

        .dropdown-footer {
            padding: 8px 16px;
            background-color: var(--light);
        }
        /* Th√™m ƒëo·∫°n m√£ n√†y ƒë·ªÉ ·∫©n n√∫t x√≥a ƒë·ªôc gi·∫£ */
        .delete-reader-btn {
            display: none !important;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Ch·ªâ th·ª±c thi script n√†y khi tab dashboard ƒë∆∞·ª£c hi·ªÉn th·ªã
            const dashboardTab = document.getElementById('v-pills-dashboard-tab');
            if (dashboardTab) {
                // Ki·ªÉm tra xem tab c√≥ ƒëang active kh√¥ng, ho·∫∑c l·∫Øng nghe s·ª± ki·ªán show
                if(dashboardTab.classList.contains('active')) {
                    initializeDashboardCalendar();
                } else {
                    dashboardTab.addEventListener('shown.bs.tab', initializeDashboardCalendar, { once: true });
                }
            }

            function initializeDashboardCalendar() {
                const monthAndYear = document.getElementById('monthAndYear');
                const calendarDays = document.getElementById('calendarDays');
                const prevMonthBtn = document.getElementById('prevMonthBtn');
                const nextMonthBtn = document.getElementById('nextMonthBtn');

                let currentDate = new Date();

                function renderCalendar() {
                    const month = currentDate.getMonth();
                    const year = currentDate.getFullYear();

                    monthAndYear.textContent = `Th√°ng ${month + 1}, ${year}`;

                    calendarDays.innerHTML = '';

                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    const today = new Date();

                    // L·∫•p ƒë·∫ßy c√°c ng√†y tr·ªëng c·ªßa th√°ng tr∆∞·ªõc
                    const daysInPrevMonth = new Date(year, month, 0).getDate();
                    for (let i = firstDayOfMonth; i > 0; i--) {
                        const dayDiv = document.createElement('div');
                        dayDiv.classList.add('prev-month');
                        dayDiv.textContent = daysInPrevMonth - i + 1;
                        calendarDays.appendChild(dayDiv);
                    }

                    // ƒêi·ªÅn c√°c ng√†y c·ªßa th√°ng hi·ªán t·∫°i
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayDiv = document.createElement('div');
                        dayDiv.textContent = i;
                        if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                            dayDiv.classList.add('today');
                        }
                        calendarDays.appendChild(dayDiv);
                    }

                    // L·∫•p ƒë·∫ßy c√°c ng√†y tr·ªëng c·ªßa th√°ng sau
                    const totalCells = calendarDays.children.length;
                    const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
                    for (let i = 1; i <= remainingCells; i++) {
                        const dayDiv = document.createElement('div');
                        dayDiv.classList.add('next-month');
                        dayDiv.textContent = i;
                        calendarDays.appendChild(dayDiv);
                    }
                }

                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });

                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                renderCalendar();
            }
        });
    </script>
</head>
<body>


<button type="button" id="sidebar-toggle-btn" class="btn shadow-sm">
    <i class="fas fa-chevron-left"></i>
</button>

<button class="btn sidebar-toggle-btn d-lg-none" id="sidebarToggle">
    <i class="fas fa-bars"></i>
</button>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/staff/dashboard">
            <i class="fas fa-book-open me-2"></i>Th∆∞ vi·ªán<span>S·ªë</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">

            <div th:if="${isAuthenticated}" class="d-flex align-items-center ms-auto">

                <span class="me-3 navbar-text" style="color: var(--dark); white-space: nowrap;">
                    Ch√†o <span th:text="${loggedInUserFullName != null ? loggedInUserFullName : 'Th·ªß th∆∞'}">Th·ªß th∆∞</span>!<span class="wave-hand-navbar">üëã</span>
                </span>

                <div class="dropdown me-3">
                    <a class="nav-link nav-icon" href="#" id="notificationDropdownToggle" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                       th:title="${unreadNotificationCount > 0 ? 'B·∫°n c√≥ ' + unreadNotificationCount + ' th√¥ng b√°o ch∆∞a ƒë·ªçc' : 'Kh√¥ng c√≥ th√¥ng b√°o m·ªõi'}">
                        <i class="fas fa-bell"></i>
                        <span th:if="${unreadNotificationCount > 0}" id="notificationBadge"
                              class="badge bg-danger rounded-pill" style="position: absolute; top: 10px; right: -5px; font-size: 0.6em; padding: 4px 6px;">
             [[${unreadNotificationCount}]]
        </span>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notification-dropdown-menu" aria-labelledby="notificationDropdownToggle">
                        <li class="dropdown-header notification-header">
                            <span>B·∫°n c√≥ th√¥ng b√°o m·ªõi</span>
                            <a href="#" id="markAllReadBtn" class="text-decoration-underline">ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</a>
                        </li>
                        <li><hr class="dropdown-divider"></li>

                        <div id="notificationListContainer">
                            <ul id="notificationList" class="list-unstyled mb-0">
                            </ul>
                        </div>

                        <li id="notificationEmptyState" class="text-center p-4 text-muted" style="display: none;">
                            <i class="far fa-bell-slash fa-2x"></i>
                            <p class="mb-0 mt-2">Kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>
                        </li>

                        <li><hr class="dropdown-divider"></li>

                        <li class="dropdown-footer text-center">
                            <button class="btn btn-link text-decoration-none" id="loadMoreBtn" style="display: none;">T·∫£i th√™m</button>
                        </li>
                    </ul>
                </div>

                <div class="dropdown">
                    <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                        <img th:if="${loggedInUserAvatarUrl}" th:src="${loggedInUserAvatarUrl}" alt="Avatar" width="32" height="32" class="rounded-circle">
                        <i th:unless="${loggedInUserAvatarUrl}" class="fas fa-user-circle fa-lg user-avatar-icon"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end text-small shadow" aria-labelledby="dropdownUserNavbar">
                        <li class="px-3 py-2 text-center">
                            <img th:if="${loggedInUserAvatarUrl != null AND !loggedInUserAvatarUrl.isEmpty()}"
                                 th:src="${loggedInUserAvatarUrl}"
                                 alt="User Avatar" width="70" height="70"
                                 class="rounded-circle mb-2 border user-avatar-dropdown">
                            <div th:unless="${loggedInUserAvatarUrl != null AND !loggedInUserAvatarUrl.isEmpty()}"
                                 class="default-avatar-dropdown mb-2">
                                <i class="fas fa-user-circle fa-4x text-muted"></i>
                            </div>
                            <h5 class="mb-0 dropdown-username"
                                th:text="${loggedInUsername != null ? loggedInUsername : 'Th·ªß th∆∞'}">
                                Username
                            </h5>
                            <p class="text-muted mb-0 dropdown-email"
                               th:text="${loggedInUserEmail != null ? loggedInUserEmail : 'email@thuvien.com'}">
                                email@example.com
                            </p>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" th:href="@{/staff/profile}" id="editProfileBtn"><i class="fas fa-user-edit me-2"></i>Th√¥ng tin t√†i kho·∫£n</a></li>
                        <li><a class="dropdown-item" href="#" id="changePasswordBtn"><i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/auth/logout}" method="post" class="d-block">
                                <button type="submit" class="dropdown-item"><i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>

            <div th:if="${!isAuthenticated}" class="ms-auto">
                <a th:href="@{/auth/login}" class="btn nav-btn btn-login me-2">ƒêƒÉng nh·∫≠p</a>
                <a th:href="@{/auth/register}" class="btn nav-btn btn-register">ƒêƒÉng k√Ω</a>
            </div>

        </div>
    </div>
</nav>


<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">

        </div>

        <ul class="nav flex-column sidebar-menu nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <li class="nav-item">
                <a class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" href="#v-pills-dashboard"
                   role="tab" aria-controls="v-pills-dashboard" aria-selected="true">
                    <i class="fas fa-tachometer-alt"></i> <span>T·ªïng quan</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="v-pills-sach-tab" data-bs-toggle="pill" href="#v-pills-sach" role="tab"
                   aria-controls="v-pills-sach" aria-selected="false">
                    <i class="fas fa-book"></i> <span>Qu·∫£n l√Ω S√°ch</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="v-pills-docgia-tab" data-bs-toggle="pill" href="#v-pills-docgia" role="tab"
                   aria-controls="v-pills-docgia" aria-selected="false">
                    <i class="fas fa-users"></i> <span>Qu·∫£n l√Ω ƒê·ªôc gi·∫£</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="v-pills-muontra-tab" data-bs-toggle="pill" href="#v-pills-muontra" role="tab"
                   aria-controls="v-pills-muontra" aria-selected="false">
                    <i class="fas fa-exchange-alt"></i> <span>Qu·∫£n l√Ω M∆∞·ª£n/Tr·∫£</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="v-pills-baocao-tab" data-bs-toggle="pill" href="#v-pills-baocao" role="tab"
                   aria-controls="v-pills-baocao" aria-selected="false">
                    <i class="fas fa-chart-pie"></i> <span>B√°o c√°o & Th·ªëng k√™</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="v-pills-phiphat-tab" data-bs-toggle="pill" href="#v-pills-phiphat" role="tab"
                   aria-controls="v-pills-phiphat" aria-selected="false">
                    <i class="fas fa-dollar-sign"></i> <span>Qu·∫£n l√Ω Ph√≠ ph·∫°t</span>
                </a>
            </li>

        </ul>
    </nav>

    <div id="content">

        <div class="tab-content" id="v-pills-tabContent">

            <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel"
                 aria-labelledby="v-pills-dashboard-tab">

                <div class="row">
                    <div class="col-xl col-md-6 mb-4">
                        <div class="card card-border-brown h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center p-3">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-brown text-uppercase mb-1" style="font-size: 0.8rem;">S√°ch ƒëang m∆∞·ª£n</div>
                                        <div class="h5 mb-0 fw-bold" th:text="${dashboardStats.borrowedBooks}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-book-reader fa-2x text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl col-md-6 mb-4">
                        <div class="card card-border-terracotta h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center p-3">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-terracotta text-uppercase mb-1" style="font-size: 0.8rem;">S√°ch qu√° h·∫°n</div>
                                        <div class="h5 mb-0 fw-bold" th:text="${dashboardStats.overdueBooks}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-exclamation-triangle fa-2x text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl col-md-6 mb-4">
                        <div class="card card-border-olive h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center p-3">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-olive text-uppercase mb-1" style="font-size: 0.8rem;">L∆∞·ª£t m∆∞·ª£n h√¥m nay</div>
                                        <div class="h5 mb-0 fw-bold" th:text="${dashboardStats.borrowsToday}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-arrow-circle-up fa-2x text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl col-md-6 mb-4">
                        <div class="card card-border-sand h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center p-3">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-sand text-uppercase mb-1" style="font-size: 0.8rem;">L∆∞·ª£t tr·∫£ h√¥m nay</div>
                                        <div class="h5 mb-0 fw-bold" th:text="${dashboardStats.returnsToday}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-arrow-circle-down fa-2x text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl col-md-6 mb-4">
                        <div class="card card-border-slate h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center p-3">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-slate text-uppercase mb-1" style="font-size: 0.8rem;">ƒê·ªôc gi·∫£ m·ªõi h√¥m nay</div>
                                        <div class="h5 mb-0 fw-bold" th:text="${dashboardStats.newReadersToday}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-user-plus fa-2x text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card calendar-container">
                            <div class="card-body">
                                <div class="calendar-header">
                                    <button id="prevMonthBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                                    <h4 id="monthAndYear" class="mb-0"></h4>
                                    <button id="nextMonthBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="calendar-weekdays">
                                    <div>CN</div>
                                    <div>T2</div>
                                    <div>T3</div>
                                    <div>T4</div>
                                    <div>T5</div>
                                    <div>T6</div>
                                    <div>T7</div>
                                </div>
                                <div class="calendar-days" id="calendarDays">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-5">
                    <div class="col-12">
                        <h4 class="page-header" style="font-size: 1.8rem; border-color: var(--border-subtle);">G√≥c c·∫£m h·ª©ng</h4>
                    </div>
                </div>
                <div class="row inspiration-gallery">
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/207756/pexels-photo-207756.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="G√≥c ƒë·ªçc s√°ch ·∫•m c√∫ng" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/1188523/pexels-photo-1188523.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Nh·ªØng cu·ªën s√°ch c≈© tr√™n k·ªá" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Th∆∞ vi·ªán v·ªõi √°nh ƒë√®n v√†ng" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/694740/pexels-photo-694740.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="M·ªôt t√°ch c√† ph√™ v√† s√°ch" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/3747502/pexels-photo-3747502.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Ng∆∞·ªùi ƒëang ƒë·ªçc s√°ch" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/2228561/pexels-photo-2228561.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="B√†n l√†m vi·ªác v·ªõi s√°ch v√† n·∫øn" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/261821/pexels-photo-261821.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="C·∫ßu thang trong th∆∞ vi·ªán c·ªï" class="img-fluid">
                    </div>
                    <div class="col-6 col-md-3 mb-4">
                        <img src="https://images.pexels.com/photos/4599736/pexels-photo-4599736.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Chi ti·∫øt g√°y s√°ch c≈©" class="img-fluid">
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="v-pills-phiphat" role="tabpanel" aria-labelledby="v-pills-phiphat-tab">
                <h2 class="page-header">Qu·∫£n l√Ω Ph√≠ ph·∫°t</h2>

                <div id="penalty-management-alert" class="alert d-none" role="alert"></div>

                <div class="card">
                    <div class="card-body">
                        <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <p class="text-muted mb-0">Danh s√°ch c√°c kho·∫£n ph√≠ ph·∫°t, nh√≥m theo t·ª´ng ƒë·ªôc gi·∫£.</p>
                            <div class="d-flex align-items-center gap-2" style="display: none;">
                                <label for="penaltyStatusFilter" class="form-label mb-0">Tr·∫°ng th√°i:</label>
                                <select class="form-select form-select-sm" id="penaltyStatusFilter" style="width: 150px;">
                                    <option value="UNPAID" selected>Ch∆∞a thanh to√°n</option>
                                    <option value="PAID">ƒê√£ thanh to√°n</option>
                                    <option value="WAIVED">ƒê√£ mi·ªÖn gi·∫£m</option>
                                    <option value="">T·∫•t c·∫£</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <form id="penalty-search-form" class="mb-0">
                                <div class="input-group">
                                    <input type="text" id="penalty-search-input" class="form-control" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n ƒë·ªôc gi·∫£ ƒë·ªÉ t√¨m...">
                                    <button class="btn btn-outline-primary" type="submit">
                                        <i class="fas fa-search me-1"></i> T√¨m ki·∫øm
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="accordion" id="penaltyFeeAccordion">
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top-0 pt-0">
                        <nav id="penaltyPagination" aria-label="Penalty Page navigation">
                        </nav>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="v-pills-muontra" role="tabpanel" aria-labelledby="v-pills-muontra-tab">
                <h2 class="page-header">Qu·∫£n l√Ω M∆∞·ª£n/Tr·∫£ s√°ch</h2>
                <div id="borrow-return-alert" class="alert d-none" role="alert"></div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header fw-bold text-primary">L·∫¨P PHI·∫æU M∆Ø·ª¢N S√ÅCH</div>
                            <div class="card-body">
                                <form id="borrow-form">
                                    <div class="mb-3">
                                        <label for="borrowerId" class="form-label">M√£ ƒë·ªôc gi·∫£</label>
                                        <input type="text" class="form-control" id="borrowerId" name="userId"
                                               placeholder="Qu√©t m√£ v·∫°ch ho·∫∑c nh·∫≠p m√£..." required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="bookIsbnBorrow" class="form-label">M√£ s√°ch (ISBN)</label>
                                        <textarea class="form-control" id="bookIsbnBorrow" name="bookIsbns" rows="3"
                                                  placeholder="Nh·∫≠p m·ªôt ho·∫∑c nhi·ªÅu ISBN, m·ªói ISBN c√°ch nhau b·∫±ng d·∫•u ph·∫©y (,)" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100"><i
                                            class="fas fa-check-circle"></i> X√°c nh·∫≠n L·∫≠p phi·∫øu
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header fw-bold text-primary">TR·∫¢ S√ÅCH</div>
                            <div class="card-body">
                                <form id="return-form">
                                    <div class="mb-3">
                                        <label for="returnReaderId" class="form-label">M√£ ƒë·ªôc gi·∫£ (T√πy ch·ªçn)</label>
                                        <input type="text" class="form-control" id="returnReaderId" name="userId"
                                               placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ ƒë·ªôc gi·∫£...">
                                    </div>
                                    <div class="mb-3">
                                        <label for="bookIsbnReturn" class="form-label">M√£ s√°ch (ISBN)</label>
                                        <textarea class="form-control" id="bookIsbnReturn" name="isbns" rows="4"
                                                  placeholder="Qu√©t ho·∫∑c nh·∫≠p nhi·ªÅu ISBN, m·ªói m√£ c√°ch nhau b·∫±ng d·∫•u ph·∫©y (,)" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100"><i class="fas fa-undo-alt"></i>
                                        X√°c nh·∫≠n Tr·∫£
                                    </button>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header fw-bold text-primary">DANH S√ÅCH PHI·∫æU M∆Ø·ª¢N ƒêANG HO·∫†T ƒê·ªòNG</div>

                    <div class="p-3 border-bottom">
                        <form id="borrowing-search-form" class="mb-0">
                            <div class="input-group">
                                <input type="text" id="borrowing-search-input" class="form-control" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n ƒë·ªôc gi·∫£ ƒë·ªÉ t√¨m ki·∫øm...">
                                <button class="btn btn-outline-primary" type="submit">
                                    <i class="fas fa-search me-1"></i> T√¨m ki·∫øm
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="card-body p-0">
                        <div class="accordion" id="borrowingAccordion">
                        </div>
                    </div>

                    <div class="card-footer bg-transparent border-top-0 pt-0">
                        <nav id="borrowingPagination" aria-label="Borrowing Page navigation">
                        </nav>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="v-pills-sach" role="tabpanel" aria-labelledby="v-pills-sach-tab">
                <h2 class="page-header">Qu·∫£n l√Ω S√°ch v√† T√†i li·ªáu</h2>
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal"><i
                                    class="fas fa-plus-circle"></i> Th√™m s√°ch m·ªõi
                            </button>
                            <div>
                                <button class="btn btn-secondary" data-bs-toggle="modal"
                                        data-bs-target="#importBookModal"><i class="fas fa-file-import"></i> Import
                                    Excel
                                </button>
                                <a th:href="@{/staff/books/export}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-export"></i> Export B√°o c√°o
                                </a>
                            </div>
                        </div>
                        <p class="text-muted">Danh s√°ch to√†n b·ªô s√°ch trong th∆∞ vi·ªán.</p>
                        <div class="card mb-4">
                            <div class="card-header fw-bold text-primary">
                                <i class="fas fa-filter me-2"></i>T√¨m ki·∫øm & L·ªçc chi ti·∫øt
                            </div>
                            <div class="card-body">
                                <form th:action="@{/staff/dashboard}" method="GET" id="book-filter-form">
                                    <input type="hidden" name="tab" value="v-pills-sach">
                                    <input type="hidden" name="startsWith" id="startsWithInput"
                                           th:value="${param.startsWith}">

                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-8">
                                            <label for="keyword" class="form-label">T√™n s√°ch / T√°c gi·∫£</label>
                                            <input type="text" class="form-control" id="keyword" name="keyword"
                                                   placeholder="Nh·∫≠p t√™n s√°ch, t√°c gi·∫£..." th:value="${param.keyword}">
                                        </div>

                                        <div class="col-md-4">
                                            <label for="filterCategory" class="form-label">Th·ªÉ lo·∫°i</label>
                                            <select class="form-select" id="filterCategory" name="categoryId">
                                                <option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
                                                <option th:each="cat : ${categories}" th:value="${cat.id}"
                                                        th:text="${cat.name}"
                                                        th:selected="${param.categoryId != null && #strings.equals(param.categoryId, cat.id)}"></option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="accordion mt-3" id="advancedFilterAccordion">
                                        <div class="accordion-item"
                                             style="background-color: transparent; border: none;">
                                            <h2 class="accordion-header" id="headingOne">
                                                <button class="accordion-button collapsed" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#collapseAdvancedFilter" aria-expanded="false"
                                                        aria-controls="collapseAdvancedFilter"
                                                        style="padding-left: 0; background-color: transparent; box-shadow: none; color: var(--primary);">
                                                    L·ªçc theo NƒÉm xu·∫•t b·∫£n v√† Ch·ªØ c√°i ƒë·∫ßu
                                                </button>
                                            </h2>
                                            <div id="collapseAdvancedFilter" class="accordion-collapse collapse"
                                                 aria-labelledby="headingOne"
                                                 data-bs-parent="#advancedFilterAccordion">
                                                <div class="accordion-body" style="padding: 1rem 0;">
                                                    <div class="row g-3 align-items-end">
                                                        <div class="col-md-3">
                                                            <label for="startYear" class="form-label">T·ª´ nƒÉm</label>
                                                            <input type="number" class="form-control" id="startYear"
                                                                   name="startYear"
                                                                   placeholder="VD: 1990" th:value="${param.startYear}">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label for="endYear" class="form-label">ƒê·∫øn nƒÉm</label>
                                                            <input type="number" class="form-control" id="endYear"
                                                                   name="endYear"
                                                                   placeholder="VD: 2025" th:value="${param.endYear}">
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <label class="form-label">L·ªçc nhanh theo ch·ªØ c√°i ƒë·∫ßu c·ªßa t√™n
                                                            s√°ch:</label>
                                                        <div class="d-flex flex-wrap gap-2 alphabet-filter">
                                                            <a th:href="@{/staff/dashboard(tab='v-pills-sach')}"
                                                               class="btn btn-sm"
                                                               th:classappend="${param.startsWith == null || param.startsWith.isEmpty()} ? 'btn-primary' : 'btn-outline-primary'">T·∫•t
                                                                c·∫£</a>
                                                            <th:block
                                                                    th:each="char : ${'A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z'.split(',')}">
                                                                <a th:href="@{/staff/dashboard(tab='v-pills-sach', startsWith=${char})}"
                                                                   class="btn btn-sm"
                                                                   th:classappend="${#strings.equals(param.startsWith, char)} ? 'btn-primary' : 'btn-outline-primary'"
                                                                   th:text="${char}"></a>
                                                            </th:block>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 mt-3 border-top pt-3">
                                        <a th:href="@{/staff/dashboard(tab='v-pills-sach')}" class="btn btn-secondary">
                                            <i class="fas fa-eraser me-1"></i> X√≥a b·ªô l·ªçc
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search me-1"></i> √Åp d·ª•ng
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                <tr>
                                    <th>T√™n s√°ch</th>
                                    <th>T√°c gi·∫£</th>
                                    <th>Th·ªÉ lo·∫°i</th>
                                    <th>ISBN</th>
                                    <th>SL T·ªìn</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                                </thead>
                                <tbody th:if="${bookPage != null and !bookPage.isEmpty()}">
                                <tr th:each="book : ${bookPage.content}">
                                    <td><strong th:text="${book.title}">Nh√† Gi·∫£ Kim</strong></td>
                                    <td th:text="${book.author}">Paulo Coelho</td>
                                    <td th:text="${book.category != null ? book.category.name : 'N/A'}">Ti·ªÉu thuy·∫øt</td>
                                    <td th:text="${book.isbn}">978-604-399-073-6</td>
                                    <td>
                                            <span class="badge"
                                                  th:text="${book.availableCopies}"
                                                  th:classappend="${book.availableCopies > 10 ? 'bg-success' : (book.availableCopies > 0 ? 'bg-warning text-dark' : 'bg-danger')}">
                                                15
                                            </span>
                                    </td>
                                    <td>
                                        <a href="#" th:attr="data-book-id=${book.id}" class="btn btn-sm btn-outline-primary edit-book-btn" data-bs-toggle="modal" data-bs-target="#editBookModal">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" th:data-book-id="${book.id}" th:data-book-title="${book.title}" class="btn btn-sm btn-outline-danger delete-book-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                                <tbody th:if="${bookPage == null or bookPage.isEmpty()}">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-book-reader fa-2x text-muted mb-2"></i>
                                        <p class="mb-0">Kh√¥ng c√≥ s√°ch n√†o trong th∆∞ vi·ªán.</p>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <nav aria-label="Page navigation" class="mt-3"
                             th:if="${bookPage != null and bookPage.totalPages > 1}">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${bookPage.isFirst()} ? 'disabled'">
                                    <a class="page-link"
                                       th:href="@{/staff/dashboard(tab='v-pills-sach', page=${bookPage.number - 1}, size=${bookPage.size})}">Tr∆∞·ªõc</a>
                                </li>

                                <li class="page-item" th:each="pageNumber : ${pageNumbers}"
                                    th:classappend="${pageNumber == bookPage.number + 1} ? 'active'">
                                    <a class="page-link"
                                       th:href="@{/staff/dashboard(tab='v-pills-sach', page=${pageNumber - 1}, size=${bookPage.size})}"
                                       th:text="${pageNumber}">1</a>
                                </li>

                                <li class="page-item" th:classappend="${bookPage.isLast()} ? 'disabled'">
                                    <a class="page-link"
                                       th:href="@{/staff/dashboard(tab='v-pills-sach', page=${bookPage.number + 1}, size=${bookPage.size})}">Sau</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="v-pills-docgia" role="tabpanel" aria-labelledby="v-pills-docgia-tab">
                <h2 class="page-header">Qu·∫£n l√Ω ƒê·ªôc gi·∫£</h2>
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReaderModal"><i
                                    class="fas fa-user-plus"></i> ƒêƒÉng k√Ω th√†nh vi√™n m·ªõi
                            </button>
                            <div>
                                <button class="btn btn-secondary" data-bs-toggle="modal"
                                        data-bs-target="#importReaderModal">
                                    <i class="fas fa-file-import"></i> Import Danh s√°ch
                                </button>
                                <a th:href="@{/staff/readers/export}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-export"></i> Export Danh s√°ch
                                </a>
                            </div>
                        </div>
                        <p class="text-muted">Danh s√°ch c√°c th√†nh vi√™n c·ªßa th∆∞ vi·ªán.</p>
                        <div class="card mb-4" style="background-color: var(--sidebar-bg);">
                            <div class="card-header fw-bold text-primary" data-bs-toggle="collapse" href="#readerFilterCollapse" role="button" aria-expanded="true" aria-controls="readerFilterCollapse" style="cursor: pointer; background-color: transparent;">
                                <i class="fas fa-filter me-2"></i>T√¨m ki·∫øm & L·ªçc chi ti·∫øt
                            </div>
                            <div class="collapse show" id="readerFilterCollapse">
                                <div class="card-body">
                                    <form id="reader-filter-form">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-12">
                                                <label for="readerKeyword" class="form-label">T√™n ƒë·ªôc gi·∫£ / M√£ th·∫ª / T√™n ƒëƒÉng nh·∫≠p</label>
                                                <input type="text" class="form-control" id="readerKeyword" name="keyword" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2 mt-3 border-top pt-3">
                                            <button type="button" class="btn btn-secondary" id="clearReaderFilterBtn">
                                                <i class="fas fa-eraser me-1"></i> X√≥a b·ªè l·ªçc
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search me-1"></i> √Åp d·ª•ng
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                <tr>
                                    <th>H·ªç t√™n</th>
                                    <th>M√£ th·∫ª</th>
                                    <th>Email</th>
                                    <th>Ph√¢n lo·∫°i</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ng√†y h·∫øt h·∫°n</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                                </thead>
                                <tbody id="readerTableBody">
                                </tbody>
                            </table>
                        </div>
                        <nav id="readerPagination" aria-label="Page navigation" class="mt-3">
                        </nav>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="v-pills-baocao" role="tabpanel" aria-labelledby="v-pills-baocao-tab">
                <h2 class="page-header">B√°o c√°o v√† Th·ªëng k√™</h2>
                <div class="row">
                    <div class="col-lg-7">
                        <div class="card mb-4">
                            <div class="card-header fw-bold text-primary">
                                <i class="fas fa-chart-bar me-2"></i>T√πy ch·ªçn Bi·ªÉu ƒë·ªì
                            </div>
                            <div class="card-body">
                                <form id="chart-options-form">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="chartType" class="form-label">Lo·∫°i bi·ªÉu ƒë·ªì</label>
                                            <select class="form-select" id="chartType">
                                                <option value="luot_muon_tra" selected>L∆∞·ª£t m∆∞·ª£n theo ng√†y</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="chartStartDate" class="form-label">T·ª´ ng√†y</label>
                                            <input type="date" class="form-control" id="chartStartDate" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="chartEndDate" class="form-label">ƒê·∫øn ng√†y</label>
                                            <input type="date" class="form-control" id="chartEndDate" required>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-3">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-sync-alt me-2"></i>T·∫£i bi·ªÉu ƒë·ªì</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div id="chart-container" style="position: relative; min-height: 350px; display: flex; align-items: center; justify-content: center;">
                                    <canvas id="reportChart" style="display: none;"></canvas>
                                    <p id="chartMessage" class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card mb-4">
                            <div class="card-header fw-bold text-primary">T√πy ch·ªçn B√°o c√°o</div>
                            <div class="card-body">
                                <form id="custom-report-form">
                                    <div class="mb-3">
                                        <label for="reportType" class="form-label">Lo·∫°i b√°o c√°o</label>
                                        <select class="form-select" id="reportType" name="report_type">
                                            <option value="luot_muon_tra" selected>L∆∞·ª£t m∆∞·ª£n/tr·∫£</option>
                                            <option value="sach_qua_han">Danh s√°ch qu√° h·∫°n</option>
                                            <option value="phieu_phat">T√†i ch√≠nh ph√≠ ph·∫°t</option>
                                            <option value="sach_theo_the_loai">Th·ªëng k√™ s√°ch theo th·ªÉ lo·∫°i</option>
                                            <option value="hoat_dong_doc_gia">Th·ªëng k√™ ho·∫°t ƒë·ªông ƒë·ªôc gi·∫£</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reportStartDate" class="form-label">T·ª´ ng√†y</label>
                                        <input type="date" class="form-control" id="reportStartDate" name="start_date">
                                    </div>
                                    <div class="mb-3">
                                        <label for="reportEndDate" class="form-label">ƒê·∫øn ng√†y</label>
                                        <input type="date" class="form-control" id="reportEndDate" name="end_date">
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100"><i
                                            class="fas fa-file-download"></i> Xem & Xu·∫•t B√°o c√°o
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBookModalLabel"><i class="fas fa-plus-circle me-2 text-primary"></i> Th√™m
                    S√°ch M·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/staff/books/add}" th:object="${newBook}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="addBookTitle" class="form-label">T√™n s√°ch <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addBookTitle" th:field="*{title}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addBookIsbn" class="form-label">ISBN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addBookIsbn" th:field="*{isbn}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addBookAuthor" class="form-label">T√°c gi·∫£</label>
                            <input type="text" class="form-control" id="addBookAuthor" th:field="*{author}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addBookCategory" class="form-label">Th·ªÉ lo·∫°i <span class="text-danger">*</span></label>
                            <select class="form-select" id="addBookCategory" name="categoryId" required>
                                <option value="" selected>Ch·ªçn th·ªÉ lo·∫°i...</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addBookPublisher" class="form-label">Nh√† xu·∫•t b·∫£n</label>
                            <input type="text" class="form-control" id="addBookPublisher" th:field="*{publisher}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addBookYear" class="form-label">NƒÉm xu·∫•t b·∫£n</label>
                            <input type="number" class="form-control" id="addBookYear" th:field="*{publicationYear}"
                                   min="1000" th:max="${#dates.year(#dates.createNow())}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="addBookQuantity" class="form-label">S·ªë l∆∞·ª£ng <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="addBookQuantity" th:field="*{availableCopies}"
                                   value="1" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addBookDescription" class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="addBookDescription" th:field="*{description}"
                                  rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="addBookImageUrl" class="form-label">·∫¢nh b√¨a (Nh·∫≠p URL ho·∫∑c t·∫£i l√™n file)</label>
                        <div class="input-group">
                            <input type="url" class="form-control" th:field="*{coverImage}" id="addBookImageUrl" placeholder="https://example.com/image.jpg">
                            <input type="file" class="form-control" name="coverImageFile" id="addCoverImageFile" accept="image/*">
                        </div>
                    </div>

                    <div class="mb-3 border-top pt-3 mt-3">
                        <label for="addSamplePdfFile" class="form-label">File PDF ƒë·ªçc th·ª≠ (T√πy ch·ªçn)</label>
                        <input type="file" class="form-control" name="samplePdfFile" id="addSamplePdfFile" accept=".pdf">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> L∆∞u l·∫°i</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBookModalLabel"><i class="fas fa-edit me-2 text-primary"></i> Ch·ªânh s·ª≠a S√°ch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBookForm" th:action="@{/staff/books/update/0}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="editBookTitle" class="form-label">T√™n s√°ch <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" id="editBookTitle" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editBookIsbn" class="form-label">ISBN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="isbn" id="editBookIsbn" required readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editBookAuthor" class="form-label">T√°c gi·∫£</label>
                            <input type="text" class="form-control" name="author" id="editBookAuthor">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editBookCategory" class="form-label">Th·ªÉ lo·∫°i</label>
                            <select class="form-select" name="categoryId" id="editBookCategory" required>
                                <option value="">Ch·ªçn th·ªÉ lo·∫°i...</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editBookPublisher" class="form-label">Nh√† xu·∫•t b·∫£n</label>
                            <input type="text" class="form-control" name="publisher" id="editBookPublisher">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="editBookYear" class="form-label">NƒÉm xu·∫•t b·∫£n</label>
                            <input type="number" class="form-control" name="publicationYear" id="editBookYear" min="1000" max="2100">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="editBookQuantity" class="form-label">S·ªë l∆∞·ª£ng <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="availableCopies" id="editBookQuantity" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editBookDescription" class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" name="description" id="editBookDescription" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="editBookImageUrl" class="form-label">·∫¢nh b√¨a (Nh·∫≠p URL ho·∫∑c t·∫£i l√™n file)</label>
                        <div class="input-group">
                            <input type="url" class="form-control" name="coverImage" id="editBookImageUrl" placeholder="https://example.com/image.jpg">
                            <input type="file" class="form-control" name="coverImageFile" id="coverImageFile" accept="image/*">
                        </div>
                    </div>

                    <div class="mb-3 border-top pt-3 mt-3">
                        <label for="editBookSamplePdf" class="form-label">File PDF ƒë·ªçc th·ª≠</label>
                        <div id="currentPdfLinkContainer" class="mb-2">
                        </div>
                        <div class="input-group">
                            <input type="file" class="form-control" id="editBookSamplePdf" accept=".pdf">
                            <button class="btn btn-outline-secondary" type="button" id="uploadPdfBtn">
                                <i class="fas fa-upload"></i> T·∫£i l√™n
                            </button>
                        </div>
                        <div id="pdfUploadStatus" class="form-text mt-1"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> C·∫≠p nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addReaderModal" tabindex="-1" aria-labelledby="addReaderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReaderModalLabel"><i class="fas fa-user-plus me-2 text-primary"></i> ƒêƒÉng
                    k√Ω Th√†nh vi√™n M·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addReaderForm" autocomplete="off">
                <div class="modal-body">
                    <div id="addReaderErrorAlert" class="alert alert-danger d-none" role="alert"></div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addReaderUserId" class="form-label">M√£ ƒë·ªôc gi·∫£ (MSSV/MSGV) <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addReaderUserId" name="userId"
                                   placeholder="VD: 215XXXXXX" required autocomplete="off">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addReaderFullName" class="form-label">H·ªç v√† t√™n <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addReaderFullName" name="fullName" required
                                   autocomplete="off">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addReaderUsername" class="form-label">T√™n ƒëƒÉng nh·∫≠p <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addReaderUsername" name="username" required
                                   autocomplete="off">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addReaderPassword" class="form-label">M·∫≠t kh·∫©u <span
                                    class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="addReaderPassword" name="password" required
                                   autocomplete="new-password">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addReaderEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="addReaderEmail" name="email"
                                   autocomplete="off">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addReaderPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="addReaderPhone" name="phone" autocomplete="off">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addReaderDob" class="form-label">Ng√†y sinh</label>
                            <input type="date" class="form-control" id="addReaderDob" name="dob">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addReaderGender" class="form-label">Gi·ªõi t√≠nh</label>
                            <select class="form-select" id="addReaderGender" name="gender">
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addReaderAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
                        <input type="text" class="form-control" id="addReaderAddress" name="address" autocomplete="off">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-primary" id="addReaderSubmitBtn"><i class="fas fa-save"></i>
                        ƒêƒÉng k√Ω
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="editLibrarianProfileModal" tabindex="-1" aria-labelledby="editLibrarianProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLibrarianProfileModalLabel"><i class="fas fa-user-edit me-2"></i> Ch·ªânh s·ª≠a Th√¥ng tin C√° nh√¢n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="librarianProfileErrorAlert" class="alert alert-danger d-none" role="alert"></div>
                <form id="editLibrarianProfileForm">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img id="librarianAvatarPreview" src="/img/default-avatar.jpg" alt="Avatar" class="rounded-circle mb-3" width="150" height="150" style="object-fit: cover; border: 3px solid var(--border-subtle);">
                            <input type="file" id="librarianAvatarFile" class="d-none" accept="image/*">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('librarianAvatarFile').click();">
                                <i class="fas fa-camera"></i> Ch·ªçn ·∫£nh m·ªõi
                            </button>
                            <p class="form-text mt-2">Dung l∆∞·ª£ng t·ªëi ƒëa 2MB. <br> ƒê·ªãnh d·∫°ng: JPG, PNG.</p>
                        </div>

                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="librarianUsername" class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
                                    <input type="text" id="librarianUsername" class="form-control" readonly disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="librarianEmail" class="form-label">Email</label>
                                    <input type="email" id="librarianEmail" class="form-control" placeholder="Nh·∫≠p email c·ªßa b·∫°n...">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="librarianFullName" class="form-label">H·ªç v√† T√™n</label>
                                <input type="text" id="librarianFullName" class="form-control" placeholder="Nh·∫≠p h·ªç v√† t√™n...">
                            </div>
                            <div class="mb-3">
                                <label for="librarianPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" id="librarianPhone" class="form-control" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
                            </div>
                            <div class="mb-3">
                                <label for="librarianAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" id="librarianAddress" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ...">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" id="saveLibrarianProfileBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editReaderModal" tabindex="-1" aria-labelledby="editReaderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReaderModalLabel"><i class="fas fa-user-edit me-2 text-primary"></i>
                    Ch·ªânh s·ª≠a Th√¥ng tin ƒê·ªôc gi·∫£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editReaderForm" method="post">
                <div class="modal-body">
                    <input type="hidden" name="userId" id="editReaderHiddenId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editReaderName" class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editReaderName" name="fullName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editReaderId" class="form-label">M√£ ƒë·ªôc gi·∫£ <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editReaderId" name="username" required readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editReaderEmail" class="form-label">Email <span
                                    class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editReaderEmail" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editReaderPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="editReaderPhone" name="phone">
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <label for="editReaderExpireDate" class="form-label">Ng√†y h·∫øt h·∫°n th·∫ª</label>
                            <input type="date" class="form-control" id="editReaderExpireDate"
                                   name="membershipExpiryDate">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editReaderAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
                        <input type="text" class="form-control" id="editReaderAddress" name="address">
                    </div>
                    <div class="mb-3">
                        <label for="editReaderStatus" class="form-label">Tr·∫°ng th√°i t√†i kho·∫£n</label>
                        <select class="form-select" id="editReaderStatus" name="status">
                            <option value="true">Ho·∫°t ƒë·ªông</option>
                            <option value="false">T·∫°m kh√≥a</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> C·∫≠p nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="importBookModal" tabindex="-1" aria-labelledby="importBookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importBookModalLabel"><i class="fas fa-file-import me-2 text-primary"></i>
                    Import Danh s√°ch S√°ch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/staff/books/import}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div th:if="${importError}" class="alert alert-danger" role="alert">
                        <strong>L·ªói!</strong> <span th:text="${importError}"></span>
                    </div>

                    <div class="mb-3">
                        <label for="bookExcelFile" class="form-label">Ch·ªçn file Excel (.xlsx):</label>
                        <input class="form-control" type="file" id="bookExcelFile" name="file" required accept=".xlsx">
                    </div>

                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-info-circle"></i> H∆∞·ªõng d·∫´n</h6>
                        <p>File Excel c·∫ßn c√≥ c√°c c·ªôt theo ƒë√∫ng th·ª© t·ª± sau ƒë√¢y:</p>
                        <p class="mb-0"><code>ISBN</code> | <code>T√™n s√°ch</code> | <code>T√°c gi·∫£</code> | <code>Th·ªÉ
                            lo·∫°i</code> | <code>Nh√† xu·∫•t b·∫£n</code> | <code>NƒÉm XB</code> | <code>S·ªë l∆∞·ª£ng</code></p>
                        <hr>
                        <a th:href="@{/templates/mau_import_sach.xlsx}" class="alert-link">T·∫£i file m·∫´u t·∫°i ƒë√¢y</a>.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-upload"></i> T·∫£i l√™n v√† X·ª≠ l√Ω
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="importReaderModal" tabindex="-1" aria-labelledby="importReaderModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importReaderModalLabel"><i class="fas fa-file-import me-2 text-primary"></i>
                    Import Danh s√°ch ƒê·ªôc gi·∫£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/staff/readers/import}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div th:if="${importReaderError}" class="alert alert-danger" role="alert">
                        <strong>L·ªói!</strong> <span th:text="${importReaderError}"></span>
                    </div>

                    <div class="mb-3">
                        <label for="readerExcelFile" class="form-label">Ch·ªçn file Excel (.xlsx):</label>
                        <input class="form-control" type="file" id="readerExcelFile" name="file" required
                               accept=".xlsx">
                    </div>

                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-info-circle"></i> H∆∞·ªõng d·∫´n</h6>
                        <p>File Excel c·∫ßn c√≥ c√°c c·ªôt theo ƒë√∫ng th·ª© t·ª± sau ƒë√¢y (d√≤ng ƒë·∫ßu ti√™n l√† ti√™u ƒë·ªÅ):</p>
                        <ul class="list-unstyled mb-0 small">
                            <li>C·ªôt A: <strong>M√£ ƒê·ªôc Gi·∫£</strong> (B·∫Øt bu·ªôc, kh√¥ng tr√πng)</li>
                            <li>C·ªôt B: <strong>T√™n ƒêƒÉng Nh·∫≠p</strong> (B·∫Øt bu·ªôc, kh√¥ng tr√πng)</li>
                            <li>C·ªôt C: <strong>H·ªç v√† T√™n</strong> (B·∫Øt bu·ªôc)</li>
                            <li>C·ªôt D: <strong>Email</strong></li>
                            <li>C·ªôt E: <strong>SƒêT</strong></li>
                            <li>C·ªôt F: <strong>Gi·ªõi t√≠nh</strong> (Nam/N·ªØ/Kh√°c)</li>
                            <li>C·ªôt G: <strong>Ng√†y sinh</strong> (ƒê·ªãnh d·∫°ng dd/MM/yyyy)</li>
                            <li>C·ªôt H: <strong>ƒê·ªãa ch·ªâ</strong></li>
                            <li>C·ªôt I: <strong>Ng√†y H·∫øt H·∫°n</strong> (ƒê·ªãnh d·∫°ng dd/MM/yyyy)</li>
                        </ul>
                        <hr>
                        <p class="mb-0">M·∫≠t kh·∫©u c·ªßa t√†i kho·∫£n m·ªõi s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t m·∫∑c ƒë·ªãnh l√† "123456".</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-upload"></i> T·∫£i l√™n v√† X·ª≠ l√Ω
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="waivePenaltyModal" tabindex="-1" aria-labelledby="waivePenaltyModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="waivePenaltyModalLabel"><i class="fas fa-gift me-2 text-info"></i> Mi·ªÖn gi·∫£m
                    Ph√≠ ph·∫°t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën mi·ªÖn gi·∫£m ph√≠ ph·∫°t cho ƒë·ªôc gi·∫£ <strong id="waiveReaderName"></strong> (S√°ch:
                    <span id="waiveBookTitle"></span>, S·ªë ti·ªÅn: <span id="waivePenaltyAmount"></span>) kh√¥ng?</p>
                <div class="mb-3">
                    <label for="waiveReason" class="form-label">L√Ω do mi·ªÖn gi·∫£m (t√πy ch·ªçn):</label>
                    <textarea class="form-control" id="waiveReason" rows="3"></textarea>
                </div>
                <input type="hidden" id="hiddenWaivePenaltyId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" id="confirmWaivePenaltyBtn" class="btn btn-warning text-dark"><i
                        class="fas fa-gift"></i> X√°c nh·∫≠n Mi·ªÖn gi·∫£m
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="penaltyDetailModal" tabindex="-1" aria-labelledby="penaltyDetailModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="penaltyDetailModalLabel"><i
                        class="fas fa-info-circle me-2 text-info"></i> Chi ti·∫øt Ph√≠ ph·∫°t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>M√£ ph·∫°t:</strong> <span id="detailPenaltyId"></span></p>
                <p><strong>M√£ m·ª•c m∆∞·ª£n:</strong> <span id="detailBorrowingId"></span></p>
                <p><strong>ƒê·ªôc gi·∫£:</strong> <span id="detailReaderName"></span> (<span
                        id="detailReaderId"></span>)</p>
                <p><strong>S√°ch:</strong> <span id="detailBookTitle"></span> (ISBN: <span
                        id="detailBookIsbn"></span>)</p>
                <p><strong>S·ªë ng√†y tr·ªÖ:</strong> <span id="detailOverdueDays"></span> ng√†y</p>
                <p><strong>S·ªë ti·ªÅn ph·∫°t:</strong> <span id="detailPenaltyAmount"></span> VNƒê</p>
                <p><strong>Tr·∫°ng th√°i:</strong> <span id="detailStatus"></span></p>
                <p><strong>Th·ªùi gian t·∫°o:</strong> <span id="detailCreatedAt"></span></p>
                <div id="paidAtSection" class="d-none">
                    <p><strong>Th·ªùi gian thanh to√°n:</strong> <span id="detailPaidAt"></span></p>
                </div>
                <div id="waivedReasonSection" class="d-none">
                    <p><strong>L√Ω do mi·ªÖn gi·∫£m:</strong> <span id="detailWaivedReason"></span></p>
                </div>
                <div id="collectedBySection" class="d-none">
                    <p><strong>Ng∆∞·ªùi x·ª≠ l√Ω:</strong> <span id="detailCollectedBy"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="overdueNotificationModal" tabindex="-1" aria-labelledby="overdueNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="overdueNotificationModalLabel"><i class="fas fa-file-invoice-dollar me-2 text-danger"></i> Th√¥ng b√°o Ph√≠ ph·∫°t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ƒê·ªôc gi·∫£ <strong id="notifyReaderName"></strong> ƒë√£ tr·∫£ s√°ch <strong id="notifyBookTitle"></strong> tr·ªÖ h·∫°n.</p>
                <p><strong>S·ªë ng√†y qu√° h·∫°n:</strong> <span id="notifyOverdueDays"></span> ng√†y</p>
                <h4 class="text-center text-danger">T·ªïng ti·ªÅn ph·∫°t: <span id="notifyTotalAmount"></span></h4>
                <input type="hidden" id="notifyPenaltyId">
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Thanh to√°n sau</button>
                <button type="button" class="btn btn-primary" id="payNowBtn"><i class="fas fa-qrcode"></i> Thanh to√°n ngay b·∫±ng QR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentQrModal" tabindex="-1" aria-labelledby="paymentQrModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentQrModalLabel"><i class="fas fa-qrcode me-2 text-primary"></i> Thanh to√°n Ph√≠ ph·∫°t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Vui l√≤ng qu√©t m√£ QR d∆∞·ªõi ƒë√¢y b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠ ƒë·ªÉ thanh to√°n.</p>
                <div id="qrCodeContainer" class="my-3" style="min-height: 250px; display: flex; align-items: center; justify-content: center;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">ƒêang t·∫°o m√£ QR...</span>
                    </div>
                </div>
                <h3 class="text-danger">S·ªë ti·ªÅn: <span id="qrAmount"></span></h3>
                <div id="paymentStatus" class="mt-3">
                    <span class="text-muted"><i class="fas fa-spinner fa-spin"></i> ƒêang ch·ªù thanh to√°n...</span>
                </div>
                <input type="hidden" id="qrPenaltyId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            </div>
        </div>
    </div>
</div>
<footer>
    <div class="container">
        <div class="row mb-5">
            <div class="col-md-4">
                <h4 class="footer-title">Th∆∞ vi·ªán S·ªë</h4>
                <p>H·ªá th·ªëng qu·∫£n l√Ω th∆∞ vi·ªán tr·ª±c tuy·∫øn hi·ªán ƒë·∫°i, gi√∫p k·∫øt n·ªëi ng∆∞·ªùi ƒë·ªçc v·ªõi kho t√†ng tri th·ª©c qua n·ªÅn
                    t·∫£ng s·ªë.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <div class="col-md-4">
                <h4 class="footer-title">Li√™n k·∫øt nhanh</h4>
                <ul class="footer-links">
                    <li><a href="/staff/dashboard"><i class="fas fa-angle-right me-2"></i>T·ªïng quan</a></li>
                    <li><a href="/staff/books"><i class="fas fa-angle-right me-2"></i>Qu·∫£n l√Ω S√°ch</a></li>
                    <li><a href="/staff/members"><i class="fas fa-angle-right me-2"></i>Qu·∫£n l√Ω ƒê·ªôc gi·∫£</a></li>
                    <li><a href="/staff/borrow-return"><i class="fas fa-angle-right me-2"></i>M∆∞·ª£n/Tr·∫£ s√°ch</a></li>
                    <li><a href="/staff/reports"><i class="fas fa-angle-right me-2"></i>B√°o c√°o Th·ªëng k√™</a></li>
                </ul>
            </div>
            <div class="col-md-4">
                <h4 class="footer-title">Th√¥ng tin th∆∞ vi·ªán</h4>
                <ul class="footer-links">
                    <li><i class="fas fa-map-marker-alt me-2"></i>276 ƒêi·ªán Bi√™n Ph·ªß, P.17, Q.B√¨nh Th·∫°nh, TP.HCM</li>
                    <li><i class="fas fa-phone-alt me-2"></i>(028) 3838 6686</li>
                    <li><i class="fas fa-envelope me-2"></i>thuvienso@uef.edu.vn</li>
                    <li><i class="fas fa-clock me-2"></i>Th·ª© 2 - Th·ª© 6: 7:30 - 17:30</li>
                    <li><i class="fas fa-clock me-2"></i>Th·ª© 7: 8:00 - 16:00</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom text-center">
            <div class="row">
                <div class="col-md-6 text-md-start mb-2 mb-md-0">
                    <p class="mb-0">¬© 2025 Th∆∞ vi·ªán S·ªë UEF. ƒê√£ ƒëƒÉng k√Ω b·∫£n quy·ªÅn.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <a href="/terms" class="me-3">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                        <a href="/privacy">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // ==========================================================
        // KH·ªûI T·∫†O CHUNG (Layout, Sidebar, Tabs)
        // ==========================================================
        const navbar = document.querySelector('.navbar.fixed-top');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const overlay = document.createElement('div');
        overlay.classList.add('overlay');
        document.body.appendChild(overlay);

        function adjustLayout() {
            if (navbar) {
                const navHeight = navbar.offsetHeight;
                document.body.style.paddingTop = navHeight + 'px';
                if (window.innerWidth >= 992) {
                    if (sidebar) {
                        sidebar.style.top = navHeight + 'px';
                        sidebar.style.height = `calc(100vh - ${navHeight}px)`;
                    }
                } else {
                    if (sidebar) {
                        sidebar.style.top = '0';
                        sidebar.style.height = '100vh';
                    }
                }
            }
        }

        adjustLayout();
        window.addEventListener('resize', adjustLayout);

        if (navbar) {
            window.addEventListener('scroll', function () {
                if (window.scrollY > 50) {
                    navbar.style.boxShadow = '0 2px 15px rgba(var(--box-shadow-base-color-rgb), 0.1)';
                } else {
                    navbar.style.boxShadow = '0 2px 10px rgba(var(--box-shadow-base-color-rgb), 0.07)';
                }
            });
        }

        if (sidebarToggle && sidebar && overlay) {
            sidebarToggle.addEventListener('click', function () {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });

            overlay.addEventListener('click', function () {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        const sidebarLinks = document.querySelectorAll('#v-pills-tab .nav-link');

        function activateTabFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash.substring(1);
            let activeTabId = hash || urlParams.get('tab') || 'v-pills-dashboard';
            const tabToActivate = document.getElementById(`${activeTabId}-tab`);
            if (tabToActivate) {
                new bootstrap.Tab(tabToActivate).show();
            }
        }

        activateTabFromUrl();

        sidebarLinks.forEach(link => {
            link.addEventListener('shown.bs.tab', function (event) {
                const newTabId = event.target.getAttribute('href').substring(1);
                const newUrl = window.location.pathname + window.location.search + `#${newTabId}`;
                history.pushState(null, '', newUrl);
            });
        });
        window.addEventListener('popstate', activateTabFromUrl);

        // ==========================================================
        // KH·ªûI T·∫†O C√ÅC MODAL V√Ä BI·∫æN TO√ÄN C·ª§C
        // ==========================================================
        const overdueNotificationModalEl = document.getElementById('overdueNotificationModal');
        const paymentQrModalEl = document.getElementById('paymentQrModal');
        const overdueNotificationModal = overdueNotificationModalEl ? new bootstrap.Modal(overdueNotificationModalEl) : null;
        const paymentQrModal = paymentQrModalEl ? new bootstrap.Modal(paymentQrModalEl) : null;
        let pollingInterval = null;

        // ==========================================================
        // H√ÄM TI·ªÜN √çCH
        // ==========================================================

        function showGenericAlert(alertElementId, message, isSuccess) {
            const alertEl = document.getElementById(alertElementId);
            if (alertEl) {
                alertEl.textContent = message;
                alertEl.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'}`;
                alertEl.classList.remove('d-none');
                setTimeout(() => alertEl.classList.add('d-none'), 5000);
            }
        }

        function renderGenericPagination(container, pageData, loadFunction) {
            if (!container) return;
            container.innerHTML = '';
            if (pageData.totalPages <= 1) return;

            const ul = document.createElement('ul');
            ul.className = 'pagination justify-content-center';

            let startPage, endPage;
            if (pageData.totalPages <= 5) {
                startPage = 0;
                endPage = pageData.totalPages;
            } else {
                if (pageData.number <= 2) {
                    startPage = 0;
                    endPage = 5;
                } else if (pageData.number + 2 >= pageData.totalPages) {
                    startPage = pageData.totalPages - 5;
                    endPage = pageData.totalPages;
                } else {
                    startPage = pageData.number - 2;
                    endPage = pageData.number + 3;
                }
            }

            ul.innerHTML += `<li class="page-item ${pageData.first ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number - 1}">Tr∆∞·ªõc</a></li>`;
            for (let i = startPage; i < endPage; i++) {
                ul.innerHTML += `<li class="page-item ${i === pageData.number ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i + 1}</a></li>`;
            }
            ul.innerHTML += `<li class="page-item ${pageData.last ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${pageData.number + 1}">Sau</a></li>`;
            container.appendChild(ul);

            container.addEventListener('click', function (e) {
                e.preventDefault();
                if (e.target.tagName === 'A' && e.target.hasAttribute('data-page')) {
                    const pageNum = parseInt(e.target.getAttribute('data-page'));
                    if (!isNaN(pageNum)) {
                        loadFunction(pageNum);
                    }
                }
            });
        }

        function displayReportInNewTab(reportData) {
            if (!reportData || typeof reportData.title !== 'string' || !Array.isArray(reportData.columns) || !Array.isArray(reportData.data)) {
                const errorHtml = `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><title>L·ªói B√°o c√°o</title></head><body><h1>L·ªói khi t·∫°o b√°o c√°o</h1><p>D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c t·ª´ m√°y ch·ªß kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã thi·∫øu. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.</p></body></html>`;
                const newTab = window.open('', '_blank');
                if (newTab) {
                    newTab.document.write(errorHtml);
                    newTab.document.close();
                }
                return;
            }

            const {title, columns, data} = reportData;
            const reportCss = `<style>body{font-family:sans-serif;margin:20px;color:#333}.report-container{max-width:900px;margin:auto;padding:30px;border:1px solid #ddd;box-shadow:0 0 10px rgba(0,0,0,.1)}.report-header{text-align:center;border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:20px}h1,h2,h3{margin:5px 0}.report-title h3{font-size:24px}.report-table{width:100%;border-collapse:collapse;margin-top:20px;margin-bottom:30px}.report-table th,.report-table td{border:1px solid #ccc;padding:10px;font-size:14px;text-align:left}.report-table th{background-color:#f2f2f2;font-weight:600}.report-table tr:nth-child(even){background-color:#f9f9f9}.print-button{padding:10px 20px;font-size:16px;cursor:pointer;margin-bottom:20px;background-color:var(--primary);color:white;border:none;border-radius:5px}@media print{.print-button{display:none}}</style>`;

            let tableHtml = `<table class="report-table"><thead><tr>${columns.map(c => `<th>${c.title}</th>`).join('')}</tr></thead><tbody>`;
            if (data && data.length > 0) {
                tableHtml += data.map(row => `<tr>${columns.map(col => `<td>${row[col.data] != null ? row[col.data] : ''}</td>`).join('')}</tr>`).join('');
            } else {
                tableHtml += `<tr><td colspan="${columns.length}" style="text-align:center;padding:20px;">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
            }
            tableHtml += `</tbody></table>`;

            // Updated primary color for the report tab
            const reportHtml = `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><title>${title}</title><style>:root{--primary:#2E935D;}</style>${reportCss}</head><body><div class="report-container"><button class="print-button" onclick="window.print()">In b√°o c√°o</button><header class="report-header"><h1>Th∆∞ Vi·ªán S·ªë</h1><h2>${title}</h2></header><main>${tableHtml}</main></div></body></html>`;

            const newTab = window.open('', '_blank');
            if (newTab) {
                newTab.document.write(reportHtml);
                newTab.document.close();
            } else {
                alert('Tr√¨nh duy·ªát c·ªßa b·∫°n ƒë√£ ch·∫∑n c·ª≠a s·ªï m·ªõi. Vui l√≤ng cho ph√©p pop-up ƒë·ªÉ xem b√°o c√°o.');
            }
        }

        // ==========================================================
        // X·ª¨ L√ù THANH TO√ÅN QR
        // ==========================================================
        async function handleQrPayment(primaryPenaltyId, amount, allPenaltyIds = []) {
            if (!paymentQrModal) return;

            if (allPenaltyIds.length === 0) {
                allPenaltyIds.push(primaryPenaltyId);
            }

            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const qrAmountEl = document.getElementById('qrAmount');
            const paymentStatusEl = document.getElementById('paymentStatus');
            paymentQrModalEl.dataset.allPenaltyIds = allPenaltyIds.join(',');

            qrCodeContainer.innerHTML = `<div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">ƒêang t·∫°o m√£ QR...</span></div>`;
            qrAmountEl.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
            paymentStatusEl.innerHTML = `<span class="text-muted"><i class="fas fa-spinner fa-spin"></i> ƒêang ch·ªù thanh to√°n...</span>`;
            document.getElementById('qrPenaltyId').value = primaryPenaltyId;

            paymentQrModal.show();

            try {
                // API t·∫°o QR v·∫´n d√πng ID ƒë·∫ßu ti√™n, nh∆∞ng g·ª≠i k√®m t·ªïng s·ªë ti·ªÅn
                // Backend c·∫ßn ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ nh·∫≠n tham s·ªë `amount` n√†y
                const response = await fetch(`/api/payment/create-qr/${primaryPenaltyId}?amount=${amount}`, { method: 'POST' });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Kh√¥ng th·ªÉ t·∫°o m√£ thanh to√°n t·ª´ server.');
                }
                const data = await response.json();
                if (data && data.qrCodeUrl) {
                    qrCodeContainer.innerHTML = `<img src="${data.qrCodeUrl}" alt="QR Code Thanh to√°n" class="img-fluid">`;
                    startPolling(primaryPenaltyId);
                } else {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c m√£ QR t·ª´ m√°y ch·ªß.");
                }
            } catch (error) {
                qrCodeContainer.innerHTML = `<div class="text-danger p-3"><i class="fas fa-times-circle me-2"></i><strong>L·ªói:</strong> ${error.message}<br><small>Vui l√≤ng th·ª≠ l·∫°i.</small></div>`;
                stopPolling();
            }
        }

        async function markMultiplePenaltiesAsPaid(penaltyIdsString) {
            const penaltyIds = penaltyIdsString.split(',');
            if (penaltyIds.length <= 1) return;

            console.log(`ƒêang c·∫≠p nh·∫≠t ${penaltyIds.length} kho·∫£n ph·∫°t...`);
            const idsToUpdate = penaltyIds.slice(1);

            for (const id of idsToUpdate) {
                try {
                    // S·ª≠ d·ª•ng API `pay` c√≥ s·∫µn ƒë·ªÉ ƒë√°nh d·∫•u t·ª´ng kho·∫£n ph·∫°t ƒë√£ thu
                    // Gi·∫£ ƒë·ªãnh backend ƒë√£ c√≥ s·∫µn user ƒëang ƒëƒÉng nh·∫≠p ƒë·ªÉ g√°n `collectedByUser`
                    await fetch(`/api/penalty-fees/pay/${id}`, { method: 'POST' });
                    console.log(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i PAID cho penalty ID: ${id}`);
                } catch (error) {
                    console.error(`L·ªói khi c·∫≠p nh·∫≠t penalty ID: ${id}`, error);
                }
            }
        }

        function startPolling(primaryPenaltyId) {
            stopPolling();
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/penalty-fees/${primaryPenaltyId}`);
                    if (!response.ok) {
                        stopPolling();
                        return;
                    }

                    const data = await response.json();
                    if (data.status === 'PAID') {
                        stopPolling();
                        const paymentStatusEl = document.getElementById('paymentStatus');
                        paymentStatusEl.innerHTML = `<div class="text-success fw-bold"><i class="fas fa-check-circle"></i> Thanh to√°n th√†nh c√¥ng!</div>`;

                        const allPenaltyIds = paymentQrModalEl.dataset.allPenaltyIds;
                        if (allPenaltyIds) {
                            await markMultiplePenaltiesAsPaid(allPenaltyIds);
                        }

                        setTimeout(() => {
                            paymentQrModal.hide();
                            if(document.getElementById('v-pills-phiphat-tab').classList.contains('active')) {
                                loadPenaltyFees();
                            }
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    stopPolling();
                }
            }, 3000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        if (paymentQrModalEl) {
            paymentQrModalEl.addEventListener('hidden.bs.modal', stopPolling);
        }

        document.getElementById('payNowBtn')?.addEventListener('click', function() {
            const penaltyId = document.getElementById('notifyPenaltyId').value;
            const amountText = document.getElementById('notifyTotalAmount').textContent.replace(/[^0-9]/g, '');
            if (penaltyId && amountText) {
                overdueNotificationModal.hide();
                handleQrPayment(penaltyId, parseInt(amountText, 10), [penaltyId]);
            }
        });

        // ==========================================================
        // TAB QU·∫¢N L√ù S√ÅCH (v-pills-sach)
        // ==========================================================
        const bookTabPane = document.getElementById('v-pills-sach');
        const editBookModalElement = document.getElementById('editBookModal');

        async function loadBookTabData(url) {
            if (!bookTabPane) return;
            const currentContent = bookTabPane.innerHTML;
            bookTabPane.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="min-height: 400px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok.');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.querySelector('#v-pills-sach');

                if (newContent) {
                    bookTabPane.innerHTML = newContent.innerHTML;
                    history.pushState({}, '', url);
                } else {
                    bookTabPane.innerHTML = currentContent;
                    alert('Kh√¥ng th·ªÉ t·∫£i l·∫°i n·ªôi dung. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Failed to load book tab data:', error);
                bookTabPane.innerHTML = currentContent;
                alert('ƒê√£ x·∫£y ra l·ªói khi l√†m m·ªõi danh s√°ch s√°ch.');
            }
        }

        if (bookTabPane) {
            bookTabPane.addEventListener('submit', function (event) {
                if (event.target.matches('#book-filter-form')) {
                    event.preventDefault();
                    const form = event.target;
                    const formData = new FormData(form);
                    const params = new URLSearchParams(formData);
                    params.set('tab', 'v-pills-sach');
                    const url = `${form.getAttribute('action')}?${params.toString()}`;
                    loadBookTabData(url);
                }
            });

            bookTabPane.addEventListener('click', function (event) {
                const target = event.target;
                const link = target.closest('a');
                const button = target.closest('button');

                if (link && (link.closest('.pagination') || link.closest('.alphabet-filter'))) {
                    event.preventDefault();
                    const url = link.getAttribute('href');
                    if (url) {
                        const form = document.getElementById('book-filter-form');
                        const formData = new FormData(form);
                        const formParams = new URLSearchParams(formData);
                        const linkUrl = new URL(url, window.location.origin);
                        formParams.forEach((value, key) => {
                            if (!linkUrl.searchParams.has(key) && value) {
                                linkUrl.searchParams.set(key, value);
                            }
                        });
                        linkUrl.searchParams.set('tab', 'v-pills-sach');
                        loadBookTabData(linkUrl.toString());
                    }
                }

                if (link && link.href.includes("dashboard?tab=v-pills-sach") && !link.closest('.pagination') && !link.closest('.alphabet-filter')) {
                    event.preventDefault();
                    const url = link.getAttribute('href');
                    if (url) loadBookTabData(url);
                }

                if (button && button.matches('.delete-book-btn')) {
                    event.preventDefault();
                    const bookId = button.dataset.bookId;
                    const bookTitle = button.dataset.bookTitle;
                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch "${bookTitle}" kh√¥ng?`)) {
                        fetch(`/staff/books/delete/${bookId}`, {
                            method: 'POST'
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert('X√≥a s√°ch th√†nh c√¥ng!');
                                    loadBookTabData(window.location.href);
                                } else {
                                    alert('X√≥a s√°ch th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting book:', error);
                                alert('ƒê√£ c√≥ l·ªói x·∫£y ra.');
                            });
                    }
                }

            });
        }

        if (editBookModalElement) {
            editBookModalElement.addEventListener('show.bs.modal', async function (event) {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-book-id');
                const form = document.getElementById('editBookForm');
                form.action = `/staff/books/update/${bookId}`;

                form.dataset.bookId = bookId;

                document.getElementById('coverImageFile').value = '';
                document.getElementById('editBookSamplePdf').value = '';
                document.getElementById('pdfUploadStatus').textContent = '';
                document.getElementById('currentPdfLinkContainer').innerHTML = '';


                try {
                    const response = await fetch(`/staff/books/api/${bookId}`);
                    if (!response.ok) {
                        throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s√°ch. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                    const book = await response.json();

                    form.querySelector('#editBookTitle').value = book.title || '';
                    form.querySelector('#editBookIsbn').value = book.isbn || '';
                    form.querySelector('#editBookAuthor').value = book.author || '';
                    form.querySelector('#editBookPublisher').value = book.publisher || '';
                    form.querySelector('#editBookYear').value = book.publicationYear || '';
                    form.querySelector('#editBookQuantity').value = book.availableCopies;
                    form.querySelector('#editBookDescription').value = book.description || '';
                    form.querySelector('#editBookImageUrl').value = book.coverImage || '';

                    const categorySelect = form.querySelector('#editBookCategory');
                    categorySelect.value = (book.category && book.category.id) ? book.category.id : "";

                    if (book.samplePdfUrl) {
                        const pdfLink = `<a href="${book.samplePdfUrl}" target="_blank" class="text-success"><i class="fas fa-file-pdf"></i> Xem file ƒë·ªçc th·ª≠ hi·ªán t·∫°i</a>`;
                        document.getElementById('currentPdfLinkContainer').innerHTML = pdfLink;
                    }


                } catch (error) {
                    console.error('L·ªói khi l·∫•y th√¥ng tin s√°ch:', error);
                    alert('ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu s√°ch. Vui l√≤ng th·ª≠ l·∫°i.');
                    bootstrap.Modal.getInstance(editBookModalElement).hide();
                }
            });

            document.getElementById('uploadPdfBtn').addEventListener('click', async function() {
                const form = document.getElementById('editBookForm');
                const bookId = form.dataset.bookId;
                const pdfFile = document.getElementById('editBookSamplePdf').files[0];
                const statusEl = document.getElementById('pdfUploadStatus');

                if (!pdfFile) {
                    statusEl.textContent = 'Vui l√≤ng ch·ªçn m·ªôt file PDF.';
                    statusEl.className = 'form-text mt-1 text-danger';
                    return;
                }

                const formData = new FormData();
                formData.append('sampleFile', pdfFile);

                this.disabled = true;
                this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang t·∫£i...`;
                statusEl.textContent = 'ƒêang t·∫£i l√™n...';
                statusEl.className = 'form-text mt-1 text-muted';

                try {
                    const response = await fetch(`/staff/books/${bookId}/upload-sample`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        statusEl.textContent = result.message;
                        statusEl.className = 'form-text mt-1 text-success';

                        const pdfLink = `<a href="${result.filePath}" target="_blank" class="text-success"><i class="fas fa-file-pdf"></i> Xem file ƒë·ªçc th·ª≠ hi·ªán t·∫°i</a>`;
                        document.getElementById('currentPdfLinkContainer').innerHTML = pdfLink;
                        document.getElementById('editBookSamplePdf').value = '';
                    } else {
                        throw new Error(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.');
                    }

                } catch (error) {
                    statusEl.textContent = 'L·ªói: ' + error.message;
                    statusEl.className = 'form-text mt-1 text-danger';
                } finally {
                    this.disabled = false;
                    this.innerHTML = `<i class="fas fa-upload"></i> T·∫£i l√™n`;
                }
            });
        }

        // ==========================================================
        // TAB QU·∫¢N L√ù ƒê·ªòC GI·∫¢ (v-pills-docgia)
        // ==========================================================
        const readerTab = document.getElementById('v-pills-docgia-tab');
        const readerTableBody = document.getElementById('readerTableBody');
        const readerPagination = document.getElementById('readerPagination');
        const addReaderForm = document.getElementById('addReaderForm');
        const addReaderModal = document.getElementById('addReaderModal');
        const editReaderModal = document.getElementById('editReaderModal');
        const editReaderForm = document.getElementById('editReaderForm');
        let readersLoaded = false;
        let currentReaderId = null;

        async function loadReaders(page = 0, size = 10) {
            const keyword = document.getElementById('readerKeyword')?.value || '';
            const status = document.getElementById('readerStatus')?.value || '';
            if (!readerTableBody) return;
            readerTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>`;

            const url = `/api/readers?page=${page}&size=${size}&keyword=${encodeURIComponent(keyword)}&status=${encodeURIComponent(status)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªôc gi·∫£.');
                const readerPage = await response.json();

                readerTableBody.innerHTML = '';
                if (readerPage.content.length === 0) {
                    readerTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><i class="fas fa-users-slash fa-2x text-muted mb-2"></i><p class="mb-0">Kh√¥ng t√¨m th·∫•y ƒë·ªôc gi·∫£ n√†o ph√π h·ª£p.</p></td></tr>`;
                    if (readerPagination) readerPagination.innerHTML = '';
                    return;
                }

                readerPage.content.forEach(reader => {
                    const tr = document.createElement('tr');
                    const expiryDate = reader.membershipExpiryDate ? new Date(reader.membershipExpiryDate).toLocaleDateString('vi-VN') : 'N/A';
                    let statusBadge;
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const expiry = reader.membershipExpiryDate ? new Date(reader.membershipExpiryDate) : null;

                    if (!reader.status) {
                        statusBadge = `<span class="badge bg-secondary">B·ªã kh√≥a</span>`;
                    } else if (expiry && expiry < today) {
                        statusBadge = `<span class="badge bg-danger">H·∫øt h·∫°n</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>`;
                    }

                    tr.innerHTML = `
                    <td><strong>${reader.fullName || 'N/A'}</strong></td>
                    <td>${reader.userId}</td>
                    <td>${reader.email || 'N/A'}</td>
                    <td>${reader.role || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${expiryDate}</td>

    <td class="d-flex justify-content-center">
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editReaderModal" data-reader-id="${reader.userId}"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-outline-danger delete-reader-btn" data-reader-id="${reader.userId}" data-reader-name="${reader.fullName}"><i class="fas fa-user-times"></i></button>
    </td>`;
                    readerTableBody.appendChild(tr);
                });

                renderGenericPagination(readerPagination, readerPage, (p) => loadReaders(p, size));

            } catch (error) {
                console.error('L·ªói khi t·∫£i danh s√°ch ƒë·ªôc gi·∫£:', error);
                readerTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>`;
            }
        }

        document.getElementById('reader-filter-form')?.addEventListener('submit', (e) => { e.preventDefault(); loadReaders(); });
        document.getElementById('clearReaderFilterBtn')?.addEventListener('click', () => {
            document.getElementById('readerKeyword').value = '';
            document.getElementById('readerStatus').value = '';
            loadReaders();
        });

        if (readerTab) {
            readerTab.addEventListener('shown.bs.tab', function () {
                if (!readersLoaded) {
                    loadReaders();
                    readersLoaded = true;
                }
            });
            if (window.location.hash === '#v-pills-docgia' && !readersLoaded) {
                loadReaders();
                readersLoaded = true;
            }
        }

        if (readerTableBody) {
            readerTableBody.addEventListener('click', async function (event) {
                const deleteButton = event.target.closest('.delete-reader-btn');
                if (deleteButton) {
                    const userId = deleteButton.getAttribute('data-reader-id');
                    const userName = deleteButton.dataset.readerName || "N/A";

                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªôc gi·∫£ "${userName}" (M√£: ${userId}) kh√¥ng?`)) {
                        try {
                            const response = await fetch(`/api/readers/${userId}`, {method: 'DELETE'});
                            if (response.ok) {
                                alert('X√≥a ƒë·ªôc gi·∫£ th√†nh c√¥ng!');
                                loadReaders();
                            } else {
                                throw new Error(await response.text() || 'X√≥a ƒë·ªôc gi·∫£ th·∫•t b·∫°i.');
                            }
                        } catch (error) {
                            alert(`C√≥ l·ªói x·∫£y ra: ${error.message}`);
                        }
                    }
                }
            });
        }

        if (addReaderForm) {
            addReaderForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const submitBtn = document.getElementById('addReaderSubmitBtn');
                const errorAlert = document.getElementById('addReaderErrorAlert');
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;
                errorAlert.classList.add('d-none');

                const formData = new FormData(addReaderForm);
                const readerData = Object.fromEntries(formData.entries());
                Object.keys(readerData).forEach(key => {
                    if (readerData[key] === '') readerData[key] = null;
                });

                try {
                    const response = await fetch('/api/readers', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(readerData)
                    });
                    if (response.ok) {
                        alert('ƒêƒÉng k√Ω ƒë·ªôc gi·∫£ th√†nh c√¥ng!');
                        bootstrap.Modal.getInstance(addReaderModal).hide();
                        loadReaders();
                    } else {
                        const errorText = await response.text();
                        errorAlert.textContent = errorText || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.';
                        errorAlert.classList.remove('d-none');
                    }
                } catch (error) {
                    errorAlert.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.';
                    errorAlert.classList.remove('d-none');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `<i class="fas fa-save"></i> ƒêƒÉng k√Ω`;
                }
            });
        }

        if (addReaderModal) {
            addReaderModal.addEventListener('hidden.bs.modal', function () {
                addReaderForm.reset();
                document.getElementById('addReaderErrorAlert').classList.add('d-none');
            });
        }

        if (editReaderModal && editReaderForm) {
            editReaderModal.addEventListener('show.bs.modal', async function (event) {
                const button = event.relatedTarget;
                currentReaderId = button.getAttribute('data-reader-id');
                try {
                    const response = await fetch(`/api/readers/${currentReaderId}`);
                    if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë·ªôc gi·∫£.');
                    const reader = await response.json();
                    editReaderForm.querySelector('#editReaderId').value = reader.userId || '';
                    editReaderForm.querySelector('#editReaderHiddenId').value = reader.userId || '';
                    editReaderForm.querySelector('#editReaderName').value = reader.fullName || '';
                    editReaderForm.querySelector('#editReaderEmail').value = reader.email || '';
                    editReaderForm.querySelector('#editReaderPhone').value = reader.phone || '';
                    editReaderForm.querySelector('#editReaderAddress').value = reader.address || '';
                    editReaderForm.querySelector('#editReaderStatus').value = String(reader.status)
                    editReaderForm.querySelector('#editReaderExpireDate').value = reader.membershipExpiryDate ? reader.membershipExpiryDate.substring(0, 10) : '';
                } catch (error) {
                    alert('L·ªói t·∫£i d·ªØ li·ªáu ƒë·ªôc gi·∫£.');
                    event.preventDefault();
                }
            });

            editReaderForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const submitButton = editReaderForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang l∆∞u...`;
                const formData = new FormData(editReaderForm);
                const readerData = Object.fromEntries(formData.entries());
                try {
                    const response = await fetch(`/api/readers/${currentReaderId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(readerData)
                    });
                    if (response.ok) {
                        alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                        bootstrap.Modal.getInstance(editReaderModal).hide();
                        loadReaders();
                    } else {
                        throw new Error(await response.text() || 'L∆∞u th√¥ng tin th·∫•t b·∫°i.');
                    }
                } catch (error) {
                    alert(`C√≥ l·ªói x·∫£y ra: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<i class="fas fa-save"></i> C·∫≠p nh·∫≠t`;
                }
            });
        }

        // ==========================================================
        // TAB QU·∫¢N L√ù M∆Ø·ª¢N/TR·∫¢ (v-pills-muontra)
        // ==========================================================
        const borrowReturnTab = document.getElementById('v-pills-muontra-tab');
        const borrowingAccordion = document.getElementById('borrowingAccordion');
        const borrowForm = document.getElementById('borrow-form');
        const returnForm = document.getElementById('return-form');
        let borrowingsLoaded = false;

        async function loadBookLoans(page = 0, size = 5) {
            if (!borrowingAccordion) return;

            const searchInput = document.getElementById('borrowing-search-input');
            const searchTerm = searchInput ? searchInput.value : '';
            const borrowingPaginationContainer = document.getElementById('borrowingPagination');

            borrowingAccordion.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>`;
            if (borrowingPaginationContainer) borrowingPaginationContainer.innerHTML = '';

            try {
                // Th√™m c√°c tham s·ªë page, size, v√† search v√†o URL
                const response = await fetch(`/api/book-loans?page=${page}&size=${size}&search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu phi·∫øu m∆∞·ª£n.');

                const bookLoanPage = await response.json();
                const bookLoans = bookLoanPage.content;

                borrowingAccordion.innerHTML = '';
                if (bookLoans.length === 0) {
                    borrowingAccordion.innerHTML = `<div class="text-center p-4 text-muted">Kh√¥ng t√¨m th·∫•y phi·∫øu m∆∞·ª£n n√†o.</div>`;
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                bookLoans.forEach((loan) => {
                    const dueDate = new Date(loan.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    const isOverdue = today > dueDate;
                    const statusBadge = isOverdue ? `<span class="badge bg-danger">Qu√° h·∫°n</span>` : `<span class="badge bg-primary">ƒêang m∆∞·ª£n</span>`;
                    const sendEmailButton = isOverdue ? `<button class="btn btn-sm btn-outline-warning text-dark send-overdue-email-btn ms-2" data-loan-id="${loan.loanId}" title="G·ª≠i email nh·∫Øc nh·ªü"><i class="fas fa-envelope"></i> G·ª≠i nh·∫Øc nh·ªü</button>` : '';

                    const accordionItem = `
                    <div class="accordion-item accordion-item-custom">
                        <h2 class="accordion-header" id="heading-${loan.loanId}">
                            <button class="accordion-button accordion-button-custom collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${loan.loanId}">
                                <div class="d-flex w-100 justify-content-between align-items-center pe-3">
                                    <div class="flex-grow-1">
                                        <strong>#${loan.loanId} - ${loan.readerName}</strong> (${loan.readerId})
                                        <small class="d-block text-muted">M∆∞·ª£n: ${loan.items.length} cu·ªën, H·∫°n: ${new Date(loan.dueDate).toLocaleDateString('vi-VN')}</small>
                                    </div>
                                    <div class="ms-3">${statusBadge}</div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse-${loan.loanId}" class="accordion-collapse collapse" aria-labelledby="heading-${loan.loanId}" data-bs-parent="#borrowingAccordion">
                            <div class="accordion-body accordion-body-custom">
                                <table class="detail-item-table">
                                    <thead><tr style="background-color: var(--sidebar-link-hover);"><th>T√™n s√°ch</th><th>ISBN</th><th>Tr·∫°ng th√°i</th></tr></thead>
                                    <tbody>
                                        ${loan.items.map(item => `<tr><td>${item.bookTitle}</td><td>${item.bookIsbn}</td><td><span class="badge bg-info text-dark">${item.status}</span></td></tr>`).join('')}
                                    </tbody>
                                </table>
                                <div class="accordion-footer-custom d-flex justify-content-end align-items-center gap-2">
                                     <button class="btn btn-sm btn-outline-primary renew-btn" data-loan-id="${loan.loanId}" title="Gia h·∫°n phi·∫øu m∆∞·ª£n"><i class="fas fa-sync-alt"></i> Gia h·∫°n</button>
                                     ${sendEmailButton}
                                </div>
                            </div>
                        </div>
                    </div>`;
                    borrowingAccordion.innerHTML += accordionItem;
                });

                // G·ªçi h√†m render ph√¢n trang (b·∫°n c·∫ßn c√≥ h√†m n√†y)
                renderGenericPagination(borrowingPaginationContainer, bookLoanPage, loadBookLoans);
            } catch (error) {
                console.error("L·ªói t·∫£i phi·∫øu m∆∞·ª£n:", error);
                borrowingAccordion.innerHTML = `<div class="text-center p-4 text-danger">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
            }
        }

        if (borrowingAccordion) {
            borrowingAccordion.addEventListener('click', async function (event) {
                const renewButton = event.target.closest('.renew-btn');
                const sendEmailBtn = event.target.closest('.send-overdue-email-btn');

                if (renewButton) {
                    const loanId = renewButton.getAttribute('data-loan-id');
                    if (confirm(`Gia h·∫°n phi·∫øu m∆∞·ª£n #${loanId} th√™m 14 ng√†y?`)) {
                        try {
                            const response = await fetch(`/api/book-loans/renew/${loanId}`, {method: 'POST'});
                            const result = await response.json();
                            if (response.ok) {
                                showGenericAlert('borrow-return-alert', 'Gia h·∫°n phi·∫øu m∆∞·ª£n th√†nh c√¥ng!', true);
                                loadBookLoans();
                            } else {
                                throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                            }
                        } catch (error) {
                            showGenericAlert('borrow-return-alert', `L·ªói gia h·∫°n: ${error.message}`, false);
                        }
                    }
                } else if (sendEmailBtn) {
                    const loanId = sendEmailBtn.getAttribute('data-loan-id');
                    if (confirm(`B·∫°n c√≥ mu·ªën g·ª≠i email nh·∫Øc nh·ªü qu√° h·∫°n cho phi·∫øu m∆∞·ª£n #${loanId} n√†y kh√¥ng?`)) {
                        try {
                            sendEmailBtn.disabled = true;
                            sendEmailBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...`;

                            const response = await fetch(`/api/overdue-reminders/send-single-reminder/${loanId}`, { method: 'POST' });
                            const result = await response.text();

                            if (response.ok) {
                                showGenericAlert('borrow-return-alert', result, true);
                            } else {
                                throw new Error(result);
                            }
                        } catch (error) {
                            console.error('L·ªói khi g·ª≠i email nh·∫Øc nh·ªü:', error);
                            showGenericAlert('borrow-return-alert', `L·ªói g·ª≠i email: ${error.message}`, false);
                        } finally {
                            sendEmailBtn.disabled = false;
                            sendEmailBtn.innerHTML = `<i class="fas fa-envelope"></i> G·ª≠i nh·∫Øc nh·ªü`;
                        }
                    }
                }
            });
        }

        if (borrowReturnTab) {
            borrowReturnTab.addEventListener('shown.bs.tab', function () {
                if (!borrowingsLoaded) {
                    loadBookLoans();
                    borrowingsLoaded = true;
                }
            });
            if (window.location.hash === '#v-pills-muontra' && !borrowingsLoaded) {
                loadBookLoans();
                borrowingsLoaded = true;
            }
        }

        if (borrowForm) {
            borrowForm.addEventListener('submit', async e => {
                e.preventDefault();
                const btn = borrowForm.querySelector('button[type="submit"]');
                const originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;

                const userId = document.getElementById('borrowerId').value;
                const isbnsText = document.getElementById('bookIsbnBorrow').value;
                const bookIsbns = isbnsText.split(',').map(isbn => isbn.trim()).filter(isbn => isbn);

                if(!userId || bookIsbns.length === 0) {
                    showGenericAlert('borrow-return-alert', 'Vui l√≤ng nh·∫≠p m√£ ƒë·ªôc gi·∫£ v√† √≠t nh·∫•t m·ªôt ISBN.', false);
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                    return;
                }

                const requestData = { userId, bookIsbns };

                try {
                    const response = await fetch('/api/book-loans/borrow', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(requestData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh");

                    showGenericAlert('borrow-return-alert', 'L·∫≠p phi·∫øu m∆∞·ª£n th√†nh c√¥ng!', true);
                    borrowForm.reset();
                    loadBookLoans();

                } catch (error) {
                    showGenericAlert('borrow-return-alert', `L·ªói: ${error.message}`, false);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            });
        }

        if(returnForm) {
            returnForm.addEventListener('submit', async e => {
                e.preventDefault();
                const btn = returnForm.querySelector('button[type="submit"]');
                const originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;

                const userId = returnForm.querySelector('#returnReaderId').value;
                const isbnsText = returnForm.querySelector('#bookIsbnReturn').value;

                const isbns = isbnsText.split(/[\n,]+/)
                    .map(isbn => isbn.trim())
                    .filter(isbn => isbn);

                if (isbns.length === 0) {
                    showGenericAlert('borrow-return-alert', 'Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt m√£ ISBN.', false);
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                    return;
                }

                const payload = {
                    userId: userId || null,
                    isbns: isbns
                };

                try {
                    const response = await fetch('/api/book-loans/return-multiple', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        try {
                            const errorResult = await response.json();
                            throw new Error(errorResult.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.');
                        } catch (jsonError) {
                            throw new Error(await response.text());
                        }
                    }

                    const result = await response.json();

                    const successCount = result.returnedItems ? result.returnedItems.length : 0;
                    const penaltyCount = result.penaltyFees ? result.penaltyFees.length : 0;
                    const errorCount = result.errors ? result.errors.length : 0;

                    let alertMessage = `Ho√†n t·∫•t! ƒê√£ x·ª≠ l√Ω ${isbns.length} s√°ch. `;
                    alertMessage += `Th√†nh c√¥ng: ${successCount}. `;
                    alertMessage += `Ph√°t sinh ph·∫°t: ${penaltyCount}. `;
                    alertMessage += `Th·∫•t b·∫°i: ${errorCount}.`;

                    if (errorCount > 0) {
                        alertMessage += "\nChi ti·∫øt l·ªói: " + result.errors.join("; ");
                    }

                    showGenericAlert('borrow-return-alert', alertMessage, errorCount === 0);
                    returnForm.reset();
                    loadBookLoans();

                    if (document.getElementById('v-pills-phiphat-tab')?.classList.contains('active')) {
                        loadPenaltyFees();
                    }

                } catch (error) {
                    showGenericAlert('borrow-return-alert', `L·ªói: ${error.message}`, false);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            });
        }
        const borrowingSearchForm = document.getElementById('borrowing-search-form');
        if (borrowingSearchForm) {
            borrowingSearchForm.addEventListener('submit', function(e) {
                e.preventDefault(); // NgƒÉn form g·ª≠i ƒëi v√† t·∫£i l·∫°i trang
                loadBookLoans(0);     // G·ªçi l·∫°i h√†m t·∫£i danh s√°ch phi·∫øu m∆∞·ª£n, b·∫Øt ƒë·∫ßu t·ª´ trang ƒë·∫ßu ti√™n
            });
        }
        // ==========================================================
        // TAB B√ÅO C√ÅO & TH·ªêNG K√ä (v-pills-baocao)
        // ==========================================================
        const reportTab = document.getElementById('v-pills-baocao-tab');
        const reportForm = document.getElementById('custom-report-form');
        const chartOptionsForm = document.getElementById('chart-options-form');
        const reportCanvas = document.getElementById('reportChart');
        const chartMessage = document.getElementById('chartMessage');
        let reportChartInstance = null;

        if (chartOptionsForm) {
            chartOptionsForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const btn = chartOptionsForm.querySelector('button[type="submit"]');
                const originalBtnHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang t·∫£i...`;

                const requestBody = {
                    reportType: document.getElementById('chartType').value,
                    startDate: `${document.getElementById('chartStartDate').value}T00:00:00`,
                    endDate: `${document.getElementById('chartEndDate').value}T23:59:59`
                };

                if (!document.getElementById('chartStartDate').value || !document.getElementById('chartEndDate').value) {
                    alert('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c.');
                    btn.disabled = false; btn.innerHTML = originalBtnHtml; return;
                }

                try {
                    const response = await fetch('/api/reports/chart-data', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ m√°y ch·ªß.');

                    const chartData = await response.json();
                    if (reportChartInstance) reportChartInstance.destroy();

                    if (chartData && chartData.labels && chartData.labels.length > 0) {
                        chartMessage.style.display = 'none';
                        reportCanvas.style.display = 'block';
                        const ctx = reportCanvas.getContext('2d');
                        reportChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: { labels: chartData.labels, datasets: chartData.datasets },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1, callback: function(value) {if (Number.isInteger(value)) {return value;}} } } },
                                plugins: { legend: { position: 'top' }, title: { display: true, text: `Th·ªëng k√™ t·ª´ ${requestBody.startDate.split('T')[0]} ƒë·∫øn ${requestBody.endDate.split('T')[0]}` } }
                            }
                        });
                    } else {
                        reportCanvas.style.display = 'none';
                        chartMessage.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu l∆∞·ª£t m∆∞·ª£n trong kho·∫£ng th·ªùi gian n√†y.';
                        chartMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('L·ªói khi v·∫Ω bi·ªÉu ƒë·ªì:', error);
                    reportCanvas.style.display = 'none';
                    chartMessage.textContent = 'ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì.';
                    chartMessage.style.display = 'block';
                } finally {
                    btn.disabled = false; btn.innerHTML = originalBtnHtml;
                }
            });
        }

        if (reportForm) {
            reportForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitButton = reportForm.querySelector('button[type="submit"]');
                const originalButtonHtml = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang t·∫°o...`;

                const requestBody = {
                    reportType: document.getElementById('reportType').value,
                    startDate: document.getElementById('reportStartDate').value,
                    endDate: document.getElementById('reportEndDate').value
                };

                if (!requestBody.startDate || !requestBody.endDate) {
                    alert('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c.');
                    submitButton.disabled = false; submitButton.innerHTML = originalButtonHtml; return;
                }

                requestBody.startDate = `${requestBody.startDate}T00:00:00`;
                requestBody.endDate = `${requestBody.endDate}T23:59:59`;

                try {
                    const response = await fetch('/api/reports/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.');
                    }
                    const reportData = await response.json();
                    displayReportInNewTab(reportData);
                } catch (error) {
                    alert(`T·∫°o b√°o c√°o th·∫•t b·∫°i: ${error.message}\n\nVui l√≤ng ki·ªÉm tra l·∫°i c√°c tham s·ªë ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.`);
                } finally {
                    submitButton.disabled = false; submitButton.innerHTML = originalButtonHtml;
                }
            });
        }


        // ==========================================================
        // TAB QU·∫¢N L√ù PH√ç PH·∫†T (v-pills-phiphat)
        // ==========================================================
        const penaltyFeeTab = document.getElementById('v-pills-phiphat-tab');
        const penaltyFeeAccordion = document.getElementById('penaltyFeeAccordion');
        const penaltyStatusFilter = document.getElementById('penaltyStatusFilter');
        const confirmWaivePenaltyBtn = document.getElementById('confirmWaivePenaltyBtn');
        const waivePenaltyModalEl = document.getElementById('waivePenaltyModal');
        let penaltyFeesLoaded = false;


        // ===== THAY TH·∫æ TO√ÄN B·ªò H√ÄM loadPenaltyFees B·∫∞NG PHI√äN B·∫¢N N√ÇNG C·∫§P N√ÄY =====
        async function loadPenaltyFees(page = 0) {
            if (!penaltyFeeAccordion) return;

            const PENALTY_PAGE_SIZE = 5; // S·ªë nh√≥m ƒë·ªôc gi·∫£ hi·ªÉn th·ªã m·ªói trang
            const status = penaltyStatusFilter.value;
            const searchInput = document.getElementById('penalty-search-input');
            const searchTerm = searchInput ? searchInput.value : '';
            const penaltyPaginationContainer = document.getElementById('penaltyPagination');

            penaltyFeeAccordion.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>`;
            if (penaltyPaginationContainer) penaltyPaginationContainer.innerHTML = '';

            try {
                // G·ªçi API v·ªõi ƒë·∫ßy ƒë·ªß tham s·ªë. size=1000 ƒë·ªÉ l·∫•y h·∫øt d·ªØ li·ªáu ƒë√£ l·ªçc v√† nh√≥m tr√™n frontend
                const response = await fetch(`/api/penalty-fees?status=${status}&search=${encodeURIComponent(searchTerm)}&size=1000&sort=createdAt,desc`);
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ph√≠ ph·∫°t.');

                const penaltyPage = await response.json();

                if (penaltyPage.content.length === 0) {
                    penaltyFeeAccordion.innerHTML = `<div class="text-center p-4 text-muted">Kh√¥ng t√¨m th·∫•y kho·∫£n ph√≠ ph·∫°t n√†o ph√π h·ª£p.</div>`;
                    return;
                }

                // Logic nh√≥m d·ªØ li·ªáu theo ƒë·ªôc gi·∫£ (v·∫´n th·ª±c hi·ªán tr√™n frontend)
                const groupedPenalties = penaltyPage.content.reduce((acc, penalty) => {
                    const readerId = penalty.readerId;
                    if (!acc[readerId]) {
                        acc[readerId] = { readerName: penalty.readerName, readerId: penalty.readerId, items: [], totalAmount: 0, status: 'UNPAID' };
                    }
                    acc[readerId].items.push(penalty);
                    if (penalty.status === 'UNPAID') {
                        acc[readerId].totalAmount += penalty.penaltyAmount;
                    }
                    return acc;
                }, {});

                const allGroups = Object.values(groupedPenalties);

                // Logic ph√¢n trang tr√™n tr√¨nh duy·ªát
                const totalPages = Math.ceil(allGroups.length / PENALTY_PAGE_SIZE);
                const start = page * PENALTY_PAGE_SIZE;
                const end = start + PENALTY_PAGE_SIZE;
                const groupsToShow = allGroups.slice(start, end);

                penaltyFeeAccordion.innerHTML = '';
                groupsToShow.forEach((group) => {
                    const formattedTotalAmount = new Intl.NumberFormat('vi-VN').format(group.totalAmount) + 'ƒë';
                    const accordionId = `penalty-group-${group.readerId.replace(/[^a-zA-Z0-9]/g, "")}`;
                    const itemsTable = group.items.map(item => {
                        const createdAt = new Date(item.createdAt).toLocaleString('vi-VN');
                        const formattedAmount = new Intl.NumberFormat('vi-VN').format(item.penaltyAmount);
                        let actionButtons;
                        switch (item.status) {
                            case 'UNPAID':
                                actionButtons = `<button class="btn btn-sm btn-info text-white qr-payment-btn" data-penalty-id="${item.id}" data-amount="${item.penaltyAmount}" title="Thanh to√°n QR"><i class="fas fa-qrcode"></i></button> <button class="btn btn-sm btn-success pay-penalty-btn" data-penalty-id="${item.id}" title="ƒê√°nh d·∫•u ƒë√£ thu ti·ªÅn m·∫∑t"><i class="fas fa-money-check-alt"></i></button> <button class="btn btn-sm btn-outline-secondary waive-penalty-btn" data-bs-toggle="modal" data-bs-target="#waivePenaltyModal" data-penalty-id="${item.id}" data-reader-name="${item.readerName}" data-book-title="${item.bookTitle}" data-penalty-amount="${formattedAmount}ƒë" title="Mi·ªÖn gi·∫£m"><i class="fas fa-gift"></i></button>`;
                                break;
                            default:
                                actionButtons = `<button class="btn btn-sm btn-outline-info detail-penalty-btn" data-bs-toggle="modal" data-bs-target="#penaltyDetailModal" data-penalty-id="${item.id}" title="Chi ti·∫øt"><i class="fas fa-info-circle"></i></button>`;
                        }
                        return `<tr><td>${item.bookTitle}</td><td>${item.overdueDays}</td><td>${formattedAmount}ƒë</td><td><span class="badge ${item.status === 'PAID' ? 'bg-success' : 'bg-secondary'}">${item.status}</span></td><td><div class="d-flex flex-wrap gap-1">${actionButtons}</div></td></tr>`;
                    }).join('');
                    const totalPaymentButton = group.items.some(p => p.status === 'UNPAID') ? `<div class="accordion-footer-custom"><button class="btn btn-primary pay-total-btn" data-reader-id="${group.readerId}" data-total-amount="${group.totalAmount}" data-penalty-ids="${group.items.filter(p => p.status === 'UNPAID').map(p => p.id).join(',')}" title="Thanh to√°n to√†n b·ªô n·ª£"><i class="fas fa-coins me-2"></i>Thanh to√°n t·ªïng n·ª£ (${formattedTotalAmount})</button></div>` : '';
                    const accordionItemHTML = `<div class="accordion-item accordion-item-custom"><h2 class="accordion-header" id="heading-${accordionId}"><button class="accordion-button accordion-button-custom collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}"><div class="d-flex w-100 justify-content-between align-items-center pe-3"><div class="flex-grow-1"><strong>${group.readerName}</strong> (${group.readerId})<small class="d-block text-muted">T·ªïng n·ª£ ch∆∞a thanh to√°n: <span class="fw-bold text-danger">${formattedTotalAmount}</span> (${group.items.filter(i=> i.status==='UNPAID').length} cu·ªën s√°ch)</small></div></div></button></h2><div id="collapse-${accordionId}" class="accordion-collapse collapse" data-bs-parent="#penaltyFeeAccordion"><div class="accordion-body accordion-body-custom"><table class="detail-item-table"><thead><tr style="background-color: var(--sidebar-link-hover);"><th>S√°ch</th><th>Ng√†y tr·ªÖ</th><th>Ti·ªÅn ph·∫°t</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody>${itemsTable}</tbody></table>${totalPaymentButton}</div></div></div>`;
                    penaltyFeeAccordion.innerHTML += accordionItemHTML;
                });

                const mockPageData = { number: page, totalPages: totalPages, first: (page === 0), last: (page >= totalPages - 1) };
                renderGenericPagination(penaltyPaginationContainer, mockPageData, loadPenaltyFees);

            } catch (error) {
                console.error("L·ªói khi t·∫£i v√† nh√≥m ph√≠ ph·∫°t: ", error);
                penaltyFeeAccordion.innerHTML = `<div class="text-center py-4 text-danger">L·ªói t·∫£i d·ªØ li·ªáu.</div>`;
            }
        }

        if (penaltyStatusFilter) {
            penaltyStatusFilter.addEventListener('change', function() {
                loadPenaltyFees(0); // Lu√¥n t·∫£i l·∫°i t·ª´ trang ƒë·∫ßu ti√™n khi thay ƒë·ªïi b·ªô l·ªçc
            });
        }

        if (penaltyFeeAccordion) {
            penaltyFeeAccordion.addEventListener('click', async function (event) {
                const payButton = event.target.closest('.pay-penalty-btn');
                const detailButton = event.target.closest('.detail-penalty-btn');
                const qrButton = event.target.closest('.qr-payment-btn');
                const waiveButton = event.target.closest('.waive-penalty-btn');
                const payTotalButton = event.target.closest('.pay-total-btn');

                if (payTotalButton) {
                    const totalAmount = payTotalButton.dataset.totalAmount;
                    const penaltyIds = payTotalButton.dataset.penaltyIds;
                    const primaryPenaltyId = penaltyIds.split(',')[0];
                    handleQrPayment(primaryPenaltyId, totalAmount, penaltyIds.split(','));

                } else if (qrButton) {
                    const penaltyId = qrButton.dataset.penaltyId;
                    const amount = qrButton.dataset.amount;
                    handleQrPayment(penaltyId, amount, [penaltyId]);

                } else if (payButton) {
                    const penaltyId = payButton.getAttribute('data-penalty-id');
                    if (confirm('X√°c nh·∫≠n ƒë√£ thu kho·∫£n ph√≠ ph·∫°t n√†y b·∫±ng ti·ªÅn m·∫∑t?')) {
                        try {
                            const response = await fetch(`/api/penalty-fees/pay/${penaltyId}`, {method: 'POST'});
                            const result = await response.json();
                            if (response.ok) {
                                showGenericAlert('penalty-management-alert', 'ƒê√°nh d·∫•u ƒë√£ thu th√†nh c√¥ng!', true);
                                loadPenaltyFees();
                            } else {
                                throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                            }
                        } catch (error) {
                            showGenericAlert('penalty-management-alert', `L·ªói: ${error.message}`, false);
                        }
                    }
                } else if (waiveButton) {
                    document.getElementById('waiveReaderName').textContent = waiveButton.dataset.readerName;
                    document.getElementById('waiveBookTitle').textContent = waiveButton.dataset.bookTitle;
                    document.getElementById('waivePenaltyAmount').textContent = waiveButton.dataset.penaltyAmount;
                    document.getElementById('hiddenWaivePenaltyId').value = waiveButton.dataset.penaltyId;
                } else if (detailButton) {
                    const penaltyId = detailButton.getAttribute('data-penalty-id');
                    try {
                        const response = await fetch(`/api/penalty-fees/${penaltyId}`);
                        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt.');
                        const detail = await response.json();
                        document.getElementById('detailPenaltyId').textContent = detail.id;
                        document.getElementById('detailBorrowingId').textContent = detail.borrowingId;
                        document.getElementById('detailReaderName').textContent = detail.readerName;
                        document.getElementById('detailReaderId').textContent = detail.readerId;
                        document.getElementById('detailBookTitle').textContent = detail.bookTitle;
                        document.getElementById('detailBookIsbn').textContent = detail.bookIsbn;
                        document.getElementById('detailOverdueDays').textContent = detail.overdueDays;
                        document.getElementById('detailPenaltyAmount').textContent = new Intl.NumberFormat('vi-VN').format(detail.penaltyAmount) + 'ƒë';
                        document.getElementById('detailStatus').textContent = {UNPAID: 'Ch∆∞a thanh to√°n', PAID: 'ƒê√£ thanh to√°n', WAIVED: 'ƒê√£ mi·ªÖn gi·∫£m'}[detail.status] || detail.status;
                        document.getElementById('detailCreatedAt').textContent = new Date(detail.createdAt).toLocaleString('vi-VN');

                        const paidSection = document.getElementById('paidAtSection');
                        const waivedSection = document.getElementById('waivedReasonSection');
                        const collectedSection = document.getElementById('collectedBySection');

                        paidSection.classList.toggle('d-none', !(detail.status === 'PAID' && detail.paidAt));
                        if(detail.paidAt) document.getElementById('detailPaidAt').textContent = new Date(detail.paidAt).toLocaleString('vi-VN');

                        waivedSection.classList.toggle('d-none', !(detail.status === 'WAIVED' && detail.waivedReason));
                        if(detail.waivedReason) document.getElementById('detailWaivedReason').textContent = detail.waivedReason;

                        collectedSection.classList.toggle('d-none', !detail.collectedByUserName || detail.collectedByUserName === 'N/A');
                        if(detail.collectedByUserName) document.getElementById('detailCollectedBy').textContent = detail.collectedByUserName;

                    } catch (error) {
                        showGenericAlert('penalty-management-alert', `L·ªói: ${error.message}`, false);
                    }
                }
            });
        }

        if (confirmWaivePenaltyBtn) {
            confirmWaivePenaltyBtn.addEventListener('click', async function () {
                const penaltyId = document.getElementById('hiddenWaivePenaltyId').value;
                const reason = document.getElementById('waiveReason').value;
                confirmWaivePenaltyBtn.disabled = true;
                confirmWaivePenaltyBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;
                try {
                    const response = await fetch(`/api/penalty-fees/waive/${penaltyId}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ reason: reason })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showGenericAlert('penalty-management-alert', 'Mi·ªÖn gi·∫£m th√†nh c√¥ng!', true);
                        bootstrap.Modal.getInstance(waivePenaltyModalEl).hide();
                        loadPenaltyFees();
                    } else {
                        throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
                    }
                } catch (error) {
                    showGenericAlert('penalty-management-alert', `L·ªói: ${error.message}`, false);
                } finally {
                    confirmWaivePenaltyBtn.disabled = false;
                    confirmWaivePenaltyBtn.innerHTML = `<i class="fas fa-gift"></i> X√°c nh·∫≠n Mi·ªÖn gi·∫£m`;
                }
            });
        }

        if (waivePenaltyModalEl) {
            waivePenaltyModalEl.addEventListener('hidden.bs.modal', function () {
                document.getElementById('waiveReason').value = '';
            });
        }

        if (penaltyFeeTab) {
            penaltyFeeTab.addEventListener('shown.bs.tab', function () {
                if (!penaltyFeesLoaded) {
                    loadPenaltyFees();
                    penaltyFeesLoaded = true;
                }
            });
            if (window.location.hash === '#v-pills-phiphat' && !penaltyFeesLoaded) {
                loadPenaltyFees();
                penaltyFeesLoaded = true;
            }
        }

        // ===== B·∫ÆT ƒê·∫¶U ƒêO·∫†N M√É JAVASCRIPT C·∫¶N THAY TH·∫æ =====

        // SCRIPT TR∆Ø·ª¢T SIDEBAR CHO DESKTOP
        const finalSidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const bodyElement = document.body;

        if (finalSidebarToggleBtn && bodyElement) {
            finalSidebarToggleBtn.addEventListener('click', function () {
                // Ch·ªâ c·∫ßn th√™m/x√≥a class tr√™n th·∫ª body
                // M·ªçi thay ƒë·ªïi v·ªÅ giao di·ªán s·∫Ω do CSS x·ª≠ l√Ω
                bodyElement.classList.toggle('sidebar-collapsed');
            });
        }

        // ===== K·∫æT TH√öC ƒêO·∫†N M√É JAVASCRIPT C·∫¶N THAY TH·∫æ =====
        // ===== B·∫ÆT ƒê·∫¶U ƒêO·∫†N M√É C·∫¶N TH√äM =====
        const penaltySearchForm = document.getElementById('penalty-search-form');
        if (penaltySearchForm) {
            penaltySearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                loadPenaltyFees(); // G·ªçi l·∫°i h√†m load, n√≥ s·∫Ω t·ª± l·ªçc v√† b·∫Øt ƒë·∫ßu t·ª´ trang ƒë·∫ßu ti√™n
            });
        }
        // ==========================================================
// QU·∫¢N L√ù TH√îNG B√ÅO (Navbar dropdown) - PHI√äN B·∫¢N N√ÇNG C·∫§P
        // ==========================================================
        let notificationCurrentPage = 0;
        const NOTIFICATION_PAGE_SIZE = 7;
        let hasMoreNotifications = true;
        let isNotificationsLoading = false;

        function timeSince(date) {
            if (!(date instanceof Date) || isNaN(date)) return "kh√¥ng x√°c ƒë·ªãnh";
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " nƒÉm tr∆∞·ªõc";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " th√°ng tr∆∞·ªõc";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ng√†y tr∆∞·ªõc";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc";
            return Math.floor(seconds) + " gi√¢y tr∆∞·ªõc";
        }

        async function loadNotifications() {
            if (isNotificationsLoading) return;
            isNotificationsLoading = true;

            const listEl = document.getElementById('notificationList');
            const emptyStateEl = document.getElementById('notificationEmptyState');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if (notificationCurrentPage === 0) {
                listEl.innerHTML = '<li class="text-center p-3 text-muted"><div class="spinner-border text-primary spinner-border-sm"></div> ƒêang t·∫£i...</li>';
                emptyStateEl.style.display = 'none';
            } else {
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang t·∫£i...';
            }

            try {
                const response = await fetch(`/api/notifications?page=${notificationCurrentPage}&size=${NOTIFICATION_PAGE_SIZE}`);
                if (!response.ok) throw new Error(`L·ªói ${response.status}`);
                const pageData = await response.json();
                const notifications = pageData.content;

                if (notificationCurrentPage === 0) listEl.innerHTML = '';

                if (notifications.length === 0 && notificationCurrentPage === 0) {
                    emptyStateEl.style.display = 'block';
                } else {
                    emptyStateEl.style.display = 'none';
                    notifications.forEach(notif => {
                        const listItem = document.createElement('li');
                        listItem.className = `notification-item ${!notif.read ? 'unread' : ''}`;
                        listItem.dataset.notificationId = notif.id;
                        const iconClass = notif.read ? 'far fa-envelope-open text-muted' : 'fas fa-circle text-primary';
                        const titleHtml = notif.link ? `<a href="${notif.link}" class="title-link">${notif.title}</a>` : `<span class="title-link">${notif.title}</span>`;
                        const timeAgo = timeSince(new Date(notif.createdAt));
                        listItem.innerHTML = `
                            <div class="notification-icon"><i class="${iconClass}"></i></div>
                            <div class="notification-content-text">
                                <p class="mb-1">${titleHtml}</p>
                                <p class="message mb-1 small">${notif.message}</p>
                                <small class="time-ago text-secondary"><i class="far fa-clock"></i> ${timeAgo}</small>
                            </div>
                            <button class="delete-notification-btn" title="X√≥a th√¥ng b√°o"><i class="fas fa-times text-danger"></i></button>`;
                        listItem.querySelector('.notification-content-text').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (!notif.read) await markNotificationAsRead(notif.id);
                            if (notif.link) {
                                window.location.href = notif.link;
                                bootstrap.Dropdown.getInstance(document.getElementById('notificationDropdownToggle'))?.hide();
                            }
                        });
                        listEl.appendChild(listItem);
                    });
                }
                hasMoreNotifications = !pageData.last;
                loadMoreBtn.style.display = hasMoreNotifications ? 'block' : 'none';
            } catch (error) {
                console.error("L·ªói khi t·∫£i th√¥ng b√°o:", error);
                if (notificationCurrentPage === 0) listEl.innerHTML = '<li class="text-center p-3 text-danger"><i class="fas fa-exclamation-triangle"></i> L·ªói t·∫£i d·ªØ li·ªáu.</li>';
            } finally {
                isNotificationsLoading = false;
                if (loadMoreBtn) {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'T·∫£i th√™m';
                }
                await updateUnreadCount();
            }
        }

        async function updateUnreadCount() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            try {
                const response = await fetch('/api/notifications/count-unread');
                if (!response.ok) return;
                const count = parseInt(await response.text(), 10);
                if (count > 0) {
                    badge.textContent = count > 9 ? '9+' : count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                badge.style.display = 'none';
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                await fetch(`/api/notifications/${notificationId}/mark-as-read`, { method: 'POST' });
                const item = document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
                if (item) {
                    item.classList.remove('unread');
                    const icon = item.querySelector('.notification-icon i');
                    if(icon) icon.className = 'far fa-envelope-open text-muted';
                }
                await updateUnreadCount();
            } catch (error) {
                console.error(`L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc th√¥ng b√°o ${notificationId}:`, error);
            }
        }

        async function markAllAsRead() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√°nh d·∫•u t·∫•t c·∫£ l√† ƒë√£ ƒë·ªçc?')) return;
            try {
                await fetch('/api/notifications/mark-all-as-read', { method: 'POST' });
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const icon = item.querySelector('.notification-icon i');
                    if(icon) icon.className = 'far fa-envelope-open text-muted';
                });
                await updateUnreadCount();
            } catch (error) {
                alert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        async function deleteNotification(notificationId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o n√†y?')) return;
            try {
                const response = await fetch(`/api/notifications/${notificationId}`, { method: 'DELETE' });
                if(response.ok) {
                    document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`)?.remove();
                    const listEl = document.getElementById('notificationList');
                    if (listEl && listEl.children.length === 0 && !hasMoreNotifications) {
                        document.getElementById('notificationEmptyState').style.display = 'block';
                    }
                    await updateUnreadCount();
                } else {
                    throw new Error('X√≥a th·∫•t b·∫°i');
                }
            } catch (error) {
                alert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function initializeNotificationSystem() {
            const dropdownToggle = document.getElementById('notificationDropdownToggle');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const markAllBtn = document.getElementById('markAllReadBtn');
            const listEl = document.getElementById('notificationList');

            if (dropdownToggle) {
                dropdownToggle.addEventListener('show.bs.dropdown', () => {
                    notificationCurrentPage = 0;
                    hasMoreNotifications = true;
                    loadNotifications();
                });
            }
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    if (hasMoreNotifications) {
                        notificationCurrentPage++;
                        loadNotifications();
                    }
                });
            }
            if (markAllBtn) {
                markAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    markAllAsRead();
                });
            }
            if(listEl) {
                listEl.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-notification-btn');
                    if(deleteBtn) {
                        const notificationId = deleteBtn.closest('.notification-item').dataset.notificationId;
                        if(notificationId) deleteNotification(notificationId);
                    }
                });
            }
            updateUnreadCount();
        }

        // ‚ñº‚ñº‚ñº ƒê√ÇY L√Ä THAY ƒê·ªîI QUAN TR·ªåNG NH·∫§T ‚ñº‚ñº‚ñº
        // G·ªçi tr·ª±c ti·∫øp h√†m kh·ªüi t·∫°o thay v√¨ b·ªçc trong m·ªôt DOMContentLoaded kh√°c
        initializeNotificationSystem();

// G·ªçi h√†m kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', initializeNotificationSystem);
        // ===== K·∫æT TH√öC ƒêO·∫†N M√É C·∫¶N TH√äM =====
        // ===== B·∫ÆT ƒê·∫¶U: LOGIC CHO POPUP CH·ªàNH S·ª¨A TH√îNG TIN TH·ª¶ TH∆Ø =====
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editLibrarianProfileModalEl = document.getElementById('editLibrarianProfileModal');

        if (editProfileBtn && editLibrarianProfileModalEl) {
            const editLibrarianProfileModal = new bootstrap.Modal(editLibrarianProfileModalEl);
            const form = document.getElementById('editLibrarianProfileForm');
            const saveBtn = document.getElementById('saveLibrarianProfileBtn');
            const avatarFileInput = document.getElementById('librarianAvatarFile');
            const avatarPreview = document.getElementById('librarianAvatarPreview');
            const errorAlert = document.getElementById('librarianProfileErrorAlert');

            // M·ªü modal v√† t·∫£i d·ªØ li·ªáu
            editProfileBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                errorAlert.classList.add('d-none'); // ·∫®n th√¥ng b√°o l·ªói c≈©
                form.reset(); // Reset form

                try {
                    const response = await fetch('/staff/api/profile');
                    if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√° nh√¢n.');

                    const profile = await response.json();

                    document.getElementById('librarianUsername').value = profile.username || '';
                    document.getElementById('librarianEmail').value = profile.email || '';
                    document.getElementById('librarianFullName').value = profile.fullName || '';
                    document.getElementById('librarianPhone').value = profile.phone || '';
                    document.getElementById('librarianAddress').value = profile.address || '';
                    avatarPreview.src = profile.avatarUrl || '/img/default-avatar.jpg'; // D√πng ·∫£nh m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥

                    editLibrarianProfileModal.show();
                } catch (error) {
                    alert('L·ªói: ' + error.message);
                }
            });

            // Xem tr∆∞·ªõc ·∫£nh khi ng∆∞·ªùi d√πng ch·ªçn file m·ªõi
            avatarFileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        avatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // L∆∞u thay ƒë·ªïi
            saveBtn.addEventListener('click', async () => {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang l∆∞u...';
                errorAlert.classList.add('d-none');

                try {
                    // B∆∞·ªõc 1: Upload ·∫£nh ƒë·∫°i di·ªán n·∫øu c√≥ thay ƒë·ªïi
                    if (avatarFileInput.files.length > 0) {
                        const avatarFormData = new FormData();
                        avatarFormData.append('avatar', avatarFileInput.files[0]);

                        const avatarResponse = await fetch('/staff/api/profile/avatar', {
                            method: 'POST',
                            body: avatarFormData
                        });

                        if (!avatarResponse.ok) {
                            const errorData = await avatarResponse.json();
                            throw new Error(errorData.message || 'L·ªói t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán.');
                        }
                    }

                    // B∆∞·ªõc 2: C·∫≠p nh·∫≠t th√¥ng tin vƒÉn b·∫£n
                    const profileData = {
                        email: document.getElementById('librarianEmail').value,
                        fullName: document.getElementById('librarianFullName').value,
                        phone: document.getElementById('librarianPhone').value,
                        address: document.getElementById('librarianAddress').value
                    };

                    // ... b√™n trong h√†m saveBtn.addEventListener
                    const profileResponse = await fetch('/staff/api/profile', { // <--- ƒê√É S·ª¨A ƒê√öNG ƒê∆Ø·ªúNG D·∫™N
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });

                    if (!profileResponse.ok) {
                        const errorData = await profileResponse.json();
                        throw new Error(errorData.message || 'L·ªói c·∫≠p nh·∫≠t th√¥ng tin.');
                    }

                    alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
                    editLibrarianProfileModal.hide();
                    window.location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin ·ªü header

                } catch (error) {
                    errorAlert.textContent = error.message;
                    errorAlert.classList.remove('d-none');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>L∆∞u thay ƒë·ªïi';
                }
            });
        }
// ==========================================================
// B·∫ÆT ƒê·∫¶U: S·ª¨A L·ªñI IMPORT KH√îNG C·∫¶N T·∫¢I L·∫†I TRANG
// ==========================================================

// T√¨m ƒë·∫øn form import ƒë·ªôc gi·∫£
        const importReaderForm = document.querySelector('#importReaderModal form');

        if (importReaderForm) {
            importReaderForm.addEventListener('submit', async function (event) {
                // 1. NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa form (t·∫£i l·∫°i trang)
                event.preventDefault();

                const modal = document.getElementById('importReaderModal');
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnHtml = submitBtn.innerHTML;

                // V√¥ hi·ªáu h√≥a n√∫t b·∫•m v√† hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang x·ª≠ l√Ω
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang x·ª≠ l√Ω...`;

                // 2. L·∫•y d·ªØ li·ªáu t·ª´ form (ch√≠nh l√† file Excel)
                const formData = new FormData(this);

                try {
                    // 3. G·ª≠i d·ªØ li·ªáu l√™n server b·∫±ng fetch
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        // Y√™u c·∫ßu server tr·∫£ v·ªÅ JSON ƒë·ªÉ d·ªÖ x·ª≠ l√Ω l·ªói
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    // 4. X·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ server
                    if (response.ok) {
                        // N·∫øu th√†nh c√¥ng
                        alert('Import danh s√°ch ƒë·ªôc gi·∫£ th√†nh c√¥ng!');
                        // ƒê√≥ng modal import
                        bootstrap.Modal.getInstance(modal).hide();
                        // **QUAN TR·ªåNG: G·ªçi l·∫°i h√†m loadReaders ƒë·ªÉ l√†m m·ªõi b·∫£ng d·ªØ li·ªáu**
                        loadReaders();
                    } else {
                        // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã l·ªói cho ng∆∞·ªùi d√πng
                        const errorData = await response.json();
                        alert(`Import th·∫•t b·∫°i: ${errorData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh. Vui l√≤ng ki·ªÉm tra l·∫°i file.'}`);
                    }
                } catch (error) {
                    console.error('L·ªói khi g·ª≠i form import:', error);
                    alert('ƒê√£ c√≥ l·ªói k·∫øt n·ªëi x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
                } finally {
                    // D√π th√†nh c√¥ng hay th·∫•t b·∫°i, tr·∫£ l·∫°i tr·∫°ng th√°i ban ƒë·∫ßu cho n√∫t b·∫•m
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHtml;
                }
            });
        }
// ==========================================================
// K·∫æT TH√öC: S·ª¨A L·ªñI IMPORT KH√îNG C·∫¶N T·∫¢I L·∫†I TRANG
// ==========================================================
    });

</script>
</body>
</html>